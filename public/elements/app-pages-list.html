<dom-module id="app-pages-list" >
  <template>
    <style include="shared-styles"></style>
    <style >
      :host {
        display: block;
      }

      .loadingIndicator {
        font-size: 16px;
        text-align: center;
        height: 60px;
      }

      .loadingIndicator paper-spinner {
        margin-right: 20px;
        vertical-align: middle;
      }
    </style>

    <iron-list items="[[pages]]" as="page" grid style="height:100%">
      <template>
        <div class="grid-item" tabindex$="[[tabIndex]]">
          <paper-material>
            <iron-image sizing="cover"
                        src="[[apiHost]]/pages/[[page.id]]/thumbnail" alt="Catalog Thumbnail Image">
            </iron-image>
              <div class="detail">
                <a href="/#/catalogs/page/[[page.id]]"> <iron-icon icon="wine:people"></iron-icon></a>
              </div>
          </paper-material>
        </div>
      </template>
    </iron-list>


    <div class="loadingIndicator" hidden$="[[!loading]]">
      <paper-spinner active$="[[loading]]"></paper-spinner> Fetching wine catalogs</b>
    </div>

  </template>

  <script>
    Polymer({
      is: 'app-pages-list',

      properties: {
        catalogId: {
          type: String,
          value : ''
        },
        active: {
          type: Boolean,
          value: false,
          observer : '_onActive'
        },
        apiHost : {
          type : String,
          value : ''
        }
      },

      behaviors : [EventBusBehavior, StateToggleBehavior],

      ebBind : {
        'selected-catalog-update' : '_onSelectedCatalogUpdate',
        'catalog-pages-update' : '_onCatalogPagesUpdate'
      },

      ready : function() {
        this.toggleState('loading', 'loading-state');
        this._getApi();
      },

      _onActive : function() {
        if( !this.active ) return;
        this._getCatalogPages();
      },

      _getApi : function() {
        this.ebEmit('get-api-host', {
          handler : function(host) {
            this.apiHost = host;
          }.bind(this)
        });
      },

      _onSelectedCatalogUpdate : function(id) {
        this.selected = id;
        this._getCatalogPages();
      },

      _getCatalogPages : function() {
        if( !this.selected ) return;

        this.ebEmit('get-catalog-pages', {
          id: this.selected, 
          handler: this._onCatalogPagesUpdate.bind(this)
        });
      },

      _onCatalogPagesUpdate : function(e) {
        if( !this.active || e.id !== this.selected ) return;
        if( e.state !== 'loaded' ) return;

        this.pages = e.payload.data;
        
      }
    });
  </script>
</dom-module>
