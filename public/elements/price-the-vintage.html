<!--
`price-the-vintage` is the main application element.  Controls paging based on appState.
Parses URL on hash change and sets appState.
-->

<dom-module id="price-the-vintage">
  <template>
    <style>
      :host {
        display: block;
        height: 100%;
        position: relative;
      }

      paper-toolbar {
        --paper-toolbar-background: var(--primary-color);
      }

      paper-header-panel {
        --paper-header-panel-shadow: {
          z-index: 600;
        }
      }

      iron-pages {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
    </style>

    <paper-header-panel style="height: 100%">
      <paper-toolbar>
        <app-header class="flex"></app-header>
      </paper-toolbar>


      <iron-pages 
        selected="[[selectedSection]]" 
        attr-for-selected="section" 
        selected-attribute="active">

        <app-catalogs-list section="list"></app-catalogs-list>
        <app-pages-list section="catalog"></app-pages-list>
        <app-page-markup section="page"></app-page-markup>
      </iron-pages>

    </paper-header-panel>

  </template>

  <script>

(function(){

    /**
     *  Listen for and request application state event handlers.
     **/
    var AppStateEventLoop = {
      req : {event : 'get-app-state'},
      resp : {
        event : 'app-state-update',
        handler : function(e) {
          this.selectedSection = e.section;
        }
      }
    };

    Polymer({
      is: 'price-the-vintage',

      properties : {
        /**
         * Controls the iron list selected page
         **/
        selectedSection : {
          type : String,
          value : ''
        }
      },

      /**
       * Setup event loop for application state
       **/
      eventLoops : {
        appState : AppStateEventLoop
      },

      behaviors : [EventBusBehavior, EventLoopBehavior],

      ready : function() {
        // listen for has changes to update app state
        window.addEventListener('hashchange', this._setPageAndAppState.bind(this));
        // trigger update of app state on first load
        this._setPageAndAppState();
      },

      /**
       * Set application state from url hash.  Cause the polymer app-route
       * still falls short in some areas and is a mess to implement. 
       **/
      _setPageAndAppState : function() {
        // default route information
        this.route = {
          section : 'list',
          catalog : '',
          page : '',
          edit : false
        }

        // split up the hash state
        var parts = window
          .location
          .hash
          .replace(/#/,'')
          .split('/');
        
        // remove any empty spots
        for( var i = parts.length-1; i >= 0; i-- ) {
          if( !parts[i] ) parts.splice(i);
        }

        // parse app state information based on location in hash route
        parts.forEach(this._parseRoute.bind(this));

        // set the current app state
        this.ebEmit('update-app-state', {
          state: {
            section: this.route.section,
            editingMark: this.route.edit
          }
        });

        // set the selected catalog (this may be empty)
        this.ebEmit('select-catalog-page', {id: this.route.page});

        // set the user activity, ie which catalog and page the user
        // is currently viewing (this may be empty as well).
        this.ebEmit('set-user-activity', {
          catalogId : this.route.catalog,
          pageId : this.route.page
        });
      },

      /**
       * Parse an individual route section
       **/
      _parseRoute : function(value, index) {
        switch(index) {
          case 0:
            this.route.section = 'catalog';
            this.route.catalog = value;
            this.ebEmit('select-catalog', {id: value});
            break;
          case 1:
            this.route.section = 'page';
            this.route.page = value;
            break;
          case 2:
            if( value === 'edit') this.route.edit = true;
        }
      }
      
    });

})();
  </script>

</dom-module>
