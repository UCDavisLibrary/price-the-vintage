<!--
`price-the-vintage` is the main application element.  Controls paging based on appState.
Parses URL on hash change and sets appState.
-->

<dom-module id="price-the-vintage">
  <template>
    <style>
      :host {
        display: block;
        height: 100%;
        position: relative;
      }

      paper-toolbar {
        --paper-toolbar-background: var(--primary-color);
      }

      paper-header-panel {
        --paper-header-panel-shadow: {
          z-index: 600;
        }
      }

      iron-pages {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
    </style>

    <paper-header-panel style="height: 100%">
      <paper-toolbar>
        <app-header class="flex"></app-header>
      </paper-toolbar>


      <iron-pages 
        selected="[[selectedSection]]" 
        attr-for-selected="section" 
        selected-attribute="active">

        <app-catalogs-list section="list"></app-catalogs-list>
        <app-pages-list section="catalog"></app-pages-list>
        <app-page-markup section="page"></app-page-markup>
      </iron-pages>

    </paper-header-panel>

  </template>

  <script>
    Polymer({
      is: 'price-the-vintage',

      properties : {
        /**
         * Controls the iron list selected page
         **/
        selectedSection : {
          type : String,
          value : ''
        }
      },


      eventLoops : {

        appState : {
          req : {event : 'get-app-state'},
          resp : {
            event : 'app-state-update',
            handler : function(e) {
              this.selectedSection = e.section;
            }
          }
        }

      },

      behaviors : [EventBusBehavior, EventLoopBehavior],

      ready : function() {
        window.addEventListener('hashchange', this._setPageAndAppState.bind(this));
        this._setPageAndAppState();
        this.eventLoop.appState.req();
      },

      _setPageAndAppState : function() {
        this.route = {
          section : 'list',
          catalog : '',
          page : '',
          edit : false
        }

        var parts = window
          .location
          .hash
          .replace(/#/,'')
          .split('/');
        
        for( var i = parts.length-1; i >= 0; i-- ) {
          if( !parts[i] ) parts.splice(i);
        }

        parts.forEach(this._parseRoute.bind(this));

        this.ebEmit('update-app-state', {
          state: {
            section: this.route.section,
            editingMark: this.route.edit
          }
        });

        this.ebEmit('select-catalog-page', {id: this.route.page});

        this.ebEmit('set-user-activity', {
          catalogId : this.route.catalog,
          pageId : this.route.page
        });
      },

      _parseRoute : function(value, index) {
        switch(index) {
          case 0:
            this.route.section = 'catalog';
            this.route.catalog = value;
            this.ebEmit('select-catalog', {id: value});
            break;
          case 1:
            this.route.section = 'page';
            this.route.page = value;
            break;
          case 2:
            if( value === 'edit') this.route.edit = true;
        }
      }
      
    });
  </script>

</dom-module>
