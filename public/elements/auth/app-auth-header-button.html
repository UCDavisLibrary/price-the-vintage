
<dom-module id="app-auth-header-button">
  <template>
    <style>
      :host {
        display: inline-block;
      }

      img {
        width: 36px;
        height: 36px;
        border-radius: 20px;
        border: 1px solid white;
        cursor: pointer;
      }

      img:hover {
        border: 1px solid var(--light-primary-color);
      }

      [state="loggedIn"] {
        position: relative;
      }

      #logout {
        z-index: 1000;
        color: black;
        display: none;
        position: absolute;
        top: 45px;
        background-color: white;
        right: 0px;
        padding: 10px;
        box-shadow: 0 0 8px rgba(0,0,0,.5);
      }
      a {
        cursor: pointer;
      }
    </style>

    <div state="pending">...</div>
    
    <div state="loggedIn">
      <paper-icon-button icon="social:person" hidden$="[[hasPhoto]]" on-click="_toggleLogout"></paper-icon-button>
      <img src="[[auth.user.photoURL]]" hidden$="[[!hasPhoto]]" on-click="_toggleLogout" />

      <div id="logout">
        <div>[[auth.user.email]]</div>
        <div style="white-space: nowrap; color: blue">
          <paper-icon-button on-click="_logout" icon="exit-to-app"></paper-icon-button> 
          <a on-click="_logout">Logout</a>
        </div>
      </div>
    </div>

    <div state="notLoggedIn">
      <paper-icon-button on-click="_login" icon="power-settings-new"></paper-icon-button>
    </div>

    <app-login-popup id="popup"></app-login-popup>
    
  </template>
  <script>

(function() {

    var AuthStateEventLoop = {
      req : {
        event : 'get-auth-state'
      },
      resp : {
        event : 'auth-update',
        handler : function(e) {
          this.auth = e;

          this.hasPhoto = false;
          if( this.auth.user ) {

            if( this.auth.state === 'loggedIn' ) {
              if( !this.auth.user.isAnonymous && !this.auth.user.emailVerified ){
                this.$.popup.show();
                this.$.popup.handleLogin(this.auth.user);
              }
            }

            if( this.auth.user && this.auth.user.photoURL ) {
              this.hasPhoto = true;
            }
          }

          this.toggleState(e.state);
        }
      }
    }

    Polymer({
      is: "app-auth-header-button",

      properties : {
        user : {
          type : Object,
          value : null
        }
      },

      behaviors : [EventBusBehavior, EventLoopBehavior, StateToggleBehavior],

      eventLoops : {
        authState : AuthStateEventLoop
      },

      ready : function() {
        this.toggleState('pending');
        this.eventLoop.authState.req();
      },

      _logout : function() {
        this.ebEmit('auth-logout');
      },

      _login : function() {
        this.$.popup.show();
      },

      _toggleLogout : function() {
        this.$.logout.style.display = (this.$.logout.style.display === 'block') ? 'none' : 'block';
      }

    });

})();
  </script>
</dom-module>
