
<dom-module id="app-auth-header-button">
  <template>
    <style>
      :host {
        display: inline-block;
      }

      img {
        width: 36px;
        height: 36px;
        border-radius: 20px;
        border: 1px solid white;
        cursor: pointer;
      }

      img:hover {
        border: 1px solid var(--light-primary-color);
      }

      [state="loggedIn"] {
        position: relative;
      }

      #logout {
        z-index: 1000;
        color: black;
        display: none;
        position: absolute;
        top: 45px;
        background-color: white;
        right: 0px;
        padding: 10px;
        box-shadow: 0 0 8px rgba(0,0,0,.5);
      }
      a {
        cursor: pointer;
      }
    </style>

    <div state="pending">...</div>
    
    <div state="loggedIn">
      <span hidden$="[[auth.user.isAnonymous]]">
        <paper-icon-button icon="social:person" hidden$="[[hasPhoto]]" on-click="_toggleLogout"></paper-icon-button>
        <img src="[[photo]]" hidden$="[[!hasPhoto]]" on-click="_toggleLogout" />
      </span>
      <paper-icon-button on-click="_login" icon="power-settings-new" hidden$="[[!auth.user.isAnonymous]]" ></paper-icon-button>

      <div id="logout">
        <div>[[username]]</div>
        <div style="white-space: nowrap; color: blue">
          <div>
            <paper-icon-button on-click="_logout" icon="exit-to-app"></paper-icon-button> 
            <a on-click="_logout">Logout</a>
          </div>
          <div hidden$="[[!isAdmin]]">
            <a href="#admin" on-click="_hidePopup"><iron-icon icon="gavel"></iron-icon> Admin Interface</a>
            </div>
          <div hidden$="[[!auth.user.isAnonymous]]"><a on-click="_switch">Login with user account</a></div>
        </div>
      </div>
    </div>

    <div state="notLoggedIn">
      <paper-icon-button on-click="_login" icon="power-settings-new"></paper-icon-button>
    </div>


    
  </template>
  <script>

(function() {

    var AuthStateEventLoop = {
      req : {
        event : 'get-auth-state'
      },
      resp : {
        event : 'auth-update',
        handler : function(e) {
          this.auth = e;
          this._renderAuthState();
        }
      }
    }

    var AppStateEventLoop = {
      req : {event: 'get-app-state'},
      resp : {
        event : 'app-state-update',
        handler : function(e) {
          this.appState = e;
        }
      }
    };

    Polymer({
      is: "app-auth-header-button",

      properties : {
        user : {
          type : Object,
          value : null
        },

        isAdmin : {
          type : Boolean,
          value : false
        }
      },

      behaviors : [EventBusBehavior, EventLoopBehavior, StateToggleBehavior],

      ebBind : {
        'ui-show-login-popup' : '_login',
        'selected-catalog-update' : '_onSelectedCatalogUpdate',
        'selected-catalog-page-update' : '_onSelectedCatalogPageUpdate'
      },

      eventLoops : {
        authState : AuthStateEventLoop,
        appState : AppStateEventLoop
      },

      ready : function() {
        this.toggleState('pending');
        this.eventLoop.authState.req();
        this.eventLoop.appState.req();
      },

      _onSelectedCatalogUpdate : function(id) {
        this.catalogId = id;
      },

      _onSelectedCatalogPageUpdate : function(id) {
        this.pageId = id;
      },

      _logout : function() {
        this.$.logout.style.display = 'none';

        localStorage.removeItem('auth0-profile');
        this.ebEmit('auth-logout');
        if( this.appState.editingMark ) {
          window.location.hash = this.catalogId + '/' + this.pageId;
        }
      },

      _hidePopup : function() {
        this.$.logout.style.display = 'none';
      },

      _login : function() {
        this.ebEmit('login-auth0');
      },

      _switch : function() {
        this._logout();
        this._login();
        this._hidePopup();
      },

      _toggleLogout : function() {
        this.$.logout.style.display = (this.$.logout.style.display === 'block') ? 'none' : 'block';
      },

      _renderAuthState : function() {
        this.hasPhoto = false;
        this.isAdmin = false;

        if( this.auth.user ) {

          if( this.auth.user.photoURL ) {
            this.photo = this.auth.user.photoURL;
            this.hasPhoto = true;
          }

          if( this.auth.user.roles  && this.auth.user.roles.indexOf('admin') > -1 ) {
            this.isAdmin = true;
          }

          this.username = this.auth.user.name || this.auth.user.email || 'Anonymous';
        }

        this.toggleState(this.auth.state);
      }

    });

})();
  </script>
</dom-module>
