<dom-module id="app-login-popup">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
        color: black;
      }

      [aggie] {
        color: #002855;
        border: 1px solid #002855;
        margin-bottom: 0;
      }

      [google] {
        color: white;
        background-color: #ed4f32;
      }

      img {
        width: 32px;
      }

      h2 {
        margin-top: 0;
      }

      paper-button {
        text-align: center;
        display: block;
        margin: 15px 10%;
        text-transform: none;
      }

      .help {
        padding: 5px;
        color: #888;
        font-size: 12px;
        margin-bottom: 15px;
      }

      a {
        cursor: pointer;
        color: var(--default-primary-color);
      }

    </style>

    <paper-dialog id="dialog" modal>
      <iron-pages selected="[[page]]" attr-for-selected="id">
        <div id="login">
          <h2>Login <paper-icon-button style="float:right" icon="close" on-click="hide"></paper-icon-button></h2>

          <paper-button on-click="loginWithUCD" aggie>
            <div style="display:inline-block">
              <div class="layout center">
                <img src="/images/AggieLogo.png" /> 
                <div>UC Davis via Google</div>
              </div>
            </div>
          </paper-button>
          <div class="help">UC Davis accounts are managed through Google.  You will be sent to a Google Account selection screen.  Please select or 
            enter your full @ucdavis.edu.  You will then be redirected to UC Davis to login.
          </div>

          <paper-button on-click="loginWithGoogle" Google>Google</paper-button>

          <div style="margin: 25px 12%">

            <paper-input type="text" id="signInEmail" label="email"></paper-input>
            <paper-input type="password" id="signInPassword" label="password"></paper-input>

            <div id="badEmailPass">
              <div class="layout">
                <div style="color: red" class="flex">
                  Invalid email or password.
                </div>
                <div class="flex" style="text-align: right">
                  <a on-click="_resetPassword">Click here</a> to reset your password.
                </div>
              </div>
            </div>

            <div class="layout">
              <div class="flex">
                <paper-button on-click="loginWithPassword" raised>Login</paper-button>
              </div>
              <div class="flex">
                <paper-button on-click="_signUp" raised>Create Account</paper-button>
              </div>
            </div>
          </div>
        </div>
        <div id="signUp">
          <h2>Create Account <paper-icon-button style="float:right" icon="close" on-click="_back"></paper-icon-button></h2>

          <paper-input type="text" id="createEmail" label="email"></paper-input>
          <paper-input type="password" id="createPassword" label="password"></paper-input>

          <div id="badCreate" style="color: red"></div>

          <paper-button on-click="_create" raised>Create</paper-button>
        </div>
        <div id="verify">
          <h2>Verify Email</h2>

          <div>
            Please check your email <b>[[user.email]]</b> and click the link to verify your email.
          </div>

          <div>
            Once you have verified your email, <a on-click="_recheckVerification">click here to continue.</a>
          </div>

          <paper-button on-click="_resendVerification" raised>Resend Verification</paper-button>
        </div>
    </paper-dialog>

  </template>
  <script>
    Polymer({
      is: 'app-login-popup',

      properties : {
        page : {
          type : String,
          value : 'login'
        }
      },

      behaviors : [EventBusBehavior],

      show : function() {
        this.$.badEmailPass.style.display = 'none';
        this.$.badCreate.style.display = 'none';
        
        this.$.signInEmail.value = '';
        this.$.signInPassword.value = '';
        
        this.$.createEmail.value = '';
        this.$.createPassword.value = '';

        this.page = 'login';
        this.$.dialog.open();
      },

      hide : function() {
        this.$.dialog.close();
      },

      loginWithGoogle : function() {
        this.ebEmit('auth-login-google');
      },

      loginWithUCD : function() {
        this.ebEmit('auth-login-ucd');
      },

      loginWithPassword : function() {
        this.ebEmit('auth-login-password', {
          email : this.$.signInEmail.value,
          password : this.$.signInPassword.value,
          handler : this._onPasswordResponse.bind(this)
        });
      },

      _create : function() {
        this.ebEmit('auth-create-password', {
          email : this.$.createEmail.value,
          password : this.$.createPassword.value,
          handler : this._onCreatePasswordResponse.bind(this)
        });
      },

      _resetPassword : function() {
        this.ebEmit('auth-reset-password', {
          email : this.$.signInEmail.value,
          handler : this._onResetPasswordResponse.bind(this)
        });
        alert('Please check your email ('+this.$.signInEmail.value+') and follow reset instructions.');
      },

      _onResetPasswordResponse : function(error, resp) {
        console.log('email sent', error, resp);
      },

      _back : function() {
        this.page = 'login';
      },

      _signUp : function() {
        this.page = 'signUp';
      },

      _onCreatePasswordResponse : function(error, resp) {
        if( error ) {
          this.$.badCreate.innerHTML = error.message;
        } else if( resp ) {
          this.handleLogin(resp, true);
          this.$.dialog.close();
        }
        
        this.$.badCreate.style.display =  error ? 'block' : 'none';
      },

      _recheckVerification : function() {
        this.user
            .reload()
            .then(function(user) {
              if( !this.user.emailVerified ) {
                alert('Email is still not verified.  You can send another verification email if required.');
              }

              this.handleLogin(this.user);
            }.bind(this));
      },

      handleLogin : function(user, isCreate) {
        if( user.emailVerified ) {
          return this.$.dialog.close();
        }

        this.user = user;
        this.page = 'verify';

        if( isCreate ) this._resendVerification();
      },

      _resendVerification : function() {
        this.user
            .sendEmailVerification()
            .then(function(response){
              console.log(response);
            })
            .catch(function(error){
              console.log(error);
            });
      },

      _onPasswordResponse : function(error, resp) {
        if( resp ) {
          this.handleLogin(resp);
        }

        this.$.badEmailPass.style.display =  error ? 'block' : 'none';
      }
    });
  </script>
</dom-module>
