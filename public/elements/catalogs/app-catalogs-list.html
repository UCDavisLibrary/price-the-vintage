<link rel="import" href="app-catalog-thumbnail.html">
<link rel="import" href="app-catalogs-search-results.html">
<link rel="import" href="app-catalogs-pagination.html">

<!--
  This is the main catalog list view.  Contains a list of catalog cards as well as 
  the bottom (popup) section of the search results.
-->
<dom-module id="app-catalogs-list" >
  <template>
      <style include="shared-styles"></style>
      <style>
        :host {
          display: block;
          position: absolute;
          left: 0;
          right: 0;
          top: 0;
          bottom:0;
        }

        .loadingIndicator {
          font-size: 16px;
          text-align: center;
          height: 60px;
        }

        .loadingIndicator paper-spinner {
          margin-right: 20px;
          vertical-align: middle;
        }

        .pages > .detail {
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
          background: rgba(0, 0, 0, .8);
          color: white;
          font-weight: 100;
          padding: 5px;
          opacity: 1;
          transition: opacity 0.1s;
        }

        .grid-card {
          cursor: pointer;
        }

        .detail {
          padding: 5px;
        }

        paper-fab {
          width: 32px; 
          height: 32px;
          padding: 5px;
        }

        [loading-state="loading"] {
          text-align: center;
          margin-top: 100px;
        }

        app-catalogs-search-results {
          position: absolute;
          left: 0;
          top: 0;
          right: 0;
          z-index: 50;
        }
      </style>

      <!-- This is the popup section of the catalog search results -->
      <!--<app-catalogs-search-results></app-catalogs-search-results>-->


      <div class="layout" style="justify-content: center">

        <div>
          <div style="text-align:center; overflow: auto" id="introText">
            <div style="max-width: 800px; text-align: left; margin: auto;">
              <p>Flipping through the pages of the Sherry-Lehmann catalog, produced by the famed New York City wine store, is like stepping back in time. From musings on wines by noted food and wine writer James Beard to charming descriptions of bottles stocked to captivating graphics, this is an immersive history at its finest.</p>
              
              <p>As you flip through the catalogs, you might notice a lot of wine prices. We did too. Our goal is to take those dollar amounts and turn them into a searchable database to allow researchers and wine enthusiasts to chart changing prices and tastes. But to do that, we need your help in transcribing the prices that you see on the pages. So help us ‘Price the Vintage’</p>

            </div>
          </div>

          <app-catalogs-pagination results="[[results]]" show-total></app-catalogs-pagination>
          <div style=" min-height: 685px;">
            <div loading-state="loaded" style="max-width: 800px; text-align: center" >
                
                <template is="dom-repeat" items="[[results.results]]" as="catalog">
                  <app-catalog-thumbnail 
                      style="display:inline-block"
                      class="grid-thumbnail" 
                      active="[[active]]"
                      catalog="[[catalog]]"
                      api-host="[[apiHost]]">
                    </app-catalog-thumbnail>
                </template>
                
            </div>

            <div loading-state="loading">
              <paper-spinner active></paper-spinner>
            </div>

            <div loading-state="error">
              Failed to load wine catalogs :(
            </div>
          </div>
          <app-catalogs-pagination results="[[results]]"></app-catalogs-pagination>
        </div>

      </div>

      <div style="text-align: center; padding: 25px 0;">
        <h3>Powered By</h3>
        <img src="/images/library.png" style="width:100%; max-width: 350px;" alt="UC Davis Library logo" />
      </div>

  </template>

  <script>
(function(){

    /**
     * Setup event handlers for search and when a search completes.  The only
     * time this element asks to start a search is when element is active.
     **/
    var SearchCatalogsEventLoop = {
      req : {
        event : 'search-catalogs',
        payload : function() {
          return {
            offset : 0,
            limit : 12
          }
        }
      },
      resp : {
        event : 'search-catalogs-update',
        handle : function(e) {
          return e.state === 'loaded'
        },
        handler : function(e) {
          this.results = e.results;
          this.toggleState('loaded', 'loading-state');
        },
        debounce : 500
      }
    };

    Polymer({

      is: 'app-catalogs-list',

      properties: {
        /**
         * Standard active flag
         **/
        active: {
          type: Boolean,
          value: false,
          observer : '_onActive'
        },
        /**
         * Current list of catalog results
         **/
        results : {
          type : Object,
          value : function() {
            return null
          }
        },
        /**
         * Host api from the config file
         **/
        apiHost : {
          type : String,
          value : ''
        }
      },

      // wire up event loop for search
      eventLoops : {
        searchCatalogs : SearchCatalogsEventLoop
      },

      // just listen for app state updates
      ebBind : {
        'app-state-update' : '_onAppStateUpdate'
      },

      behaviors : [EventBusBehavior, EventLoopBehavior, StateToggleBehavior],

      ready : function() {
        // start of in the loading UI state
        this.toggleState('loading', 'loading-state');
        // grab the api host from config file.
        this._getApiHost();
      },

      _onActive : function() {
        if( !this.active ) return;

        // on active, start a catalog search for current search state
        if( this.results ) return;
        this.eventLoop.searchCatalogs.req();
      },

      /**
       * When update state changes, just set the UI state
       **/
      _onAppStateUpdate : function(e) {
        if( e.searching ) {
          this.toggleState('loading', 'loading-state');
        }
      },

      /**
       * Request the api load handler
       **/
      _getApiHost : function() {
        this.ebEmit('get-api-host', {
          handler : function(host) {
            this.apiHost = host;
          }.bind(this)
        });
      }

    });
})();
  </script>

</dom-module>
