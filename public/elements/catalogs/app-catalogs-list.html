<link rel="import" href="app-catalog-card.html">
<link rel="import" href="app-catalogs-search-results.html">

<!--
  This is the main catalog list view.  Contains a list of catalog cards as well as 
  the bottom (popup) section of the search results.
-->
<dom-module id="app-catalogs-list" >
  <template>
      <style include="shared-styles"></style>
      <style>
        :host {
          display: block;
          position: absolute;
          left: 0;
          right: 0;
          top: 0;
          bottom:0;
        }

        .loadingIndicator {
          font-size: 16px;
          text-align: center;
          height: 60px;
        }

        .loadingIndicator paper-spinner {
          margin-right: 20px;
          vertical-align: middle;
        }

        .pages > .detail {
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
          background: rgba(0, 0, 0, .8);
          color: white;
          font-weight: 100;
          padding: 5px;
          opacity: 1;
          transition: opacity 0.1s;
        }

        .grid-card {
          cursor: pointer;
        }

        .detail {
          padding: 5px;
        }

        paper-fab {
          width: 32px; 
          height: 32px;
          padding: 5px;
        }

        [loading-state="loaded"] {
          position: absolute;
          left: 0;
          right: 0;
          top: 0;
          bottom:0;
        }

        [loading-state="loading"] {
          text-align: center;
          margin-top: 100px;
        }

        app-catalogs-search-results {
          position: absolute;
          left: 0;
          top: 0;
          right: 0;
          z-index: 50;
        }
      </style>

      <!-- This is the popup section of the catalog search results -->
      <app-catalogs-search-results></app-catalogs-search-results>

      <div loading-state="loaded">
        <iron-list id="list" items="[[results]]" as="catalog" grid style="height:100%">
          <template>
            <app-catalog-card 
              class="grid-card" 
              active="[[active]]"
              catalog="[[catalog]]"
              api-host="[[apiHost]]">
            </app-catalog-card>
            
          </template>
        </iron-list>
      </div>

      <div loading-state="loading">
        <paper-spinner active></paper-spinner>
      </div>

      <div loading-state="error">
        Failed to load wine catalogs :(
      </div>

  </template>

  <script>
(function(){

    /**
     * Setup event handlers for search and when a search completes.  The only
     * time this element asks to start a search is when element is active.
     **/
    var SearchCatalogsEventLoop = {
      req : {event : 'search-catalogs'},
      resp : {
        event : 'search-catalogs-update',
        handle : function(e) {
          return e.state === 'loaded'
        },
        handler : function(e) {
          this.results = e.results.results;
          this._updateListSize();
        },
        debounce : 500
      }
    };

    Polymer({

      is: 'app-catalogs-list',

      properties: {
        /**
         * Standard active flag
         **/
        active: {
          type: Boolean,
          value: false,
          observer : '_onActive'
        },
        /**
         * Current list of catalog results
         **/
        results : {
          type : Array,
          value : function() {
            return []
          }
        },
        /**
         * Host api from the config file
         **/
        apiHost : {
          type : String,
          value : ''
        }
      },

      // wire up event loop for search
      eventLoops : {
        searchCatalogs : SearchCatalogsEventLoop
      },

      // just listen for app state updates
      ebBind : {
        'app-state-update' : '_onAppStateUpdate'
      },

      behaviors : [EventBusBehavior, EventLoopBehavior, StateToggleBehavior],

      ready : function() {
        // start of in the loading UI state
        this.toggleState('loading', 'loading-state');
        // grab the api host from config file.
        this._getApiHost();
      },

      _onActive : function() {
        if( !this.active ) return;

        // on active, start a catalog search for current search state
        this.eventLoop.searchCatalogs.req();
        // update our list size in case screen has changed while hidden.
        this._updateListSize();
      },

      /**
       * When update state changes, just set the UI state
       **/
      _onAppStateUpdate : function(e) {
        if( e.searching ) {
          this.toggleState('loading', 'loading-state');
        } else {
          this.toggleState('loaded', 'loading-state');
        }
      },

      /**
       * Request the api load handler
       **/
      _getApiHost : function() {
        this.ebEmit('get-api-host', {
          handler : function(host) {
            this.apiHost = host;
          }.bind(this)
        });
      },

      /**
       * Resize the card grid
       **/
      _updateListSize : function() {
        this.$.list.fire('iron-resize');
      }

    });
})();
  </script>

</dom-module>
