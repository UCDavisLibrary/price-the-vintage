<!--
  Overlay that shows just under the header bar when the user is search.
  Shows total matches as well as provides search options.
-->
<dom-module id="app-catalogs-search-results">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
        background-color: white;
        padding: 10px;
        box-shadow: 0 0 5px black;
      }
      #toggleText {
        color: var(--secondary-text-color);
      }
    </style>

    <div class="layout center">
      <div>Contains</div>
      <paper-toggle-button id="typeToggle" on-change="_search"></paper-toggle-button>
      <div>Exact match</div>
    </div>

    <!--<div class="layout center">
      <paper-toggle-button on-click="_search"></paper-toggle-button>
      <div id="toggleText">Show only catalogs that need marking</div>
    </div>-->

    <div style="padding: 10px 0">
      <div state="loaded" style="text-align: center">
        Matched [[total]] catalogs.
      </div>
    </div>

  </template>
  <script>

(function() {

    /**
     * Wire up the search event loop
     **/
    var SearchCatalogsEventLoop = {
      req : {
        event : 'search-catalogs',
        /**
         * Before we search, start the search send event to set 
         * current options, and set the app state to searching
         **/
        handle : function() {
          this.ebEmit('update-app-state', {
            state: {
              searching : true,
              searchExact : this.$.typeToggle.checked
            }
          });
        },
        /**
         * Actually send the search
         **/
        payload : function() {
          return {
            query : {
              q : this.searchText,
              exact : this.$.typeToggle.checked
            }
          }
        },
        // only trigger this every 50ms, max
        debounce : 50
      },

      resp : {
        event : 'search-catalogs-update',
        /**
         * We only need to handle the 'loaded' search state
         **/
        handle : function(e) {
          return e.state === 'loaded'
        },
        handler : function(e) {
          this.total = e.results.total;
        }
      }
    };

    Polymer({
      is: 'app-catalogs-search-results',

      properties : {
        total : {
          type : Number,
          value : 0
        }
      },

      eventLoops : {
        searchCatalogs : SearchCatalogsEventLoop
      },

      behaviors : [EventBusBehavior, EventLoopBehavior, StateToggleBehavior],

      ebBind : {
        'app-state-update' : '_onAppStateUpdate'
      },

      _search : function() {
        this.eventLoop.searchCatalogs.req();
      },

      _onAppStateUpdate : function(e) {
        this.searchText = e.searchText;

        if( e.searching ) {
          this.toggleState('loading');
        } else {
          this.toggleState('loaded');
        }

        this.style.display = e.searchBoxActive ? 'block' : 'none';
      }
    });

})();
  </script>
</dom-module>
