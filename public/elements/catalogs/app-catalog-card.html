<dom-module id="app-catalog-card">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
      }

      paper-material {
        background :white; 
        position : relative;
      }

      h3 {
        padding: 0 5px;
      }

      .layout-vertical {
        height: 100%;
      }

      paper-material {
        transition: transform 200ms linear, box-shadow 200ms linear;
      }
      paper-material:hover {
        box-shadow: 0px -2px 15px #9C27B0;
        transform: translateY(5px);
      }

      iron-icon {
        color: var(--light-primary-color);
      }

      #loading {
        text-align: center;
        height: 148px;
      }
      #loading paper-spinner {
        padding: 25px;
      }
    </style>

    <paper-material>
      <div hidden$="[[loading]]">
        <div class="layout">

          <iron-image 
            class="grid-card-img"
            sizing="cover"
            src$="[[imgUrl]]" 
            alt="Catalog Thumbnail Image">
          </iron-image>

          <div class="flex">

            <div class="layout-vertical">
              <div class="flex">
                <h3>[[catalog.title]]</h3>
              </div>
              <div>
                <span hidden$="[[!showUserCount]]">
                  <iron-icon icon="social:group"></iron-icon> [[userCount]]
                </span>
              </div>
            </div>
            
          </div>
        </div>
      </div>
      <div id="loading" hidden$="[[!loading]]">
        <paper-spinner active></paper-spinner>
      </div>
    </paper-material>
    
  </template>
  <script>
    Polymer({
      is: 'app-catalog-card',

      properties : {
        active : {
          type : Boolean,
          value : false,
          observer : '_onUpdate'
        },
        apiHost : {
          type : String,
          value : ''
        },
        catalog : {
          type : Object,
          value : function() {
            return {};
          },
          observer : '_onUpdate'
        },
        imgUrl : {
          type : String,
          computed : '_createImgUrl(apiHost, catalog)'
        },
        userCount : {
          type : Number,
          value : 0
        },
        showUserCount : {
          type : Boolean,
          value : false
        },
        loading: {
          type : Boolean,
          value : false
        }
      },

      listeners: {
        click : '_select'
      },

      ebBind : {
        'user-activity-update' : '_onUserActivityUpdate',
        'interested-party-request' : '_onInterestedPartyRequest',
        'catalog-pages-update' : '_onCatalogPagesUpdate'
      },

      behaviors : [EventBusBehavior],

      _createImgUrl : function(apiHost, catalog) {
        return apiHost + '/catalogs/' + catalog.id + '/thumbnail';
      },

      _onUpdate : function() {
        if( !this.catalog ) return;
        if( !this.catalog.id ) return;

        this.debounce('_onUpdateAsync', function(){
          this._onUpdateAsync();
        }.bind(this), 50);
      },

      _onUpdateAsync : function() {
        if( !this.catalog.id ) return;

        this.ebEmit('get-user-activity', {
          id : this.catalog.id,
          handler : this._onUserActivityUpdate.bind(this)
        })
      },

      _onCatalogPagesUpdate : function(e) {
        if( !this.active || e.id+'' !== this.catalog.id+'' ) return;

        if( e.state !== 'loaded' ) return;
        this.loading = false;

        if( e.payload.data.length === 0 ) {
          return alert('This catalog has no pages :(');
        }

        var page = e.payload.data[0];
        window.location.hash = this.catalog.id+'/'+page.id;
      },

      _select : function(e) {
        if( !this.catalog.id ) return;
        this.loading = true;

        this.ebEmit('get-catalog-pages', {
          id: this.catalog.id,
          handler:  this._onCatalogPagesUpdate.bind(this)
        });
      },

      _onInterestedPartyRequest : function() {
        if( this.active && this.catalog && this.catalog.id  ) {
          this.ebEmit(
            'interested-party-response',
            {
              id : this.catalog.id,
              types : ['activity']
            }
          );
        }
      },

      _onUserActivityUpdate : function(e) {
        if( e.id+'' !== this.catalog.id+'' ) return;

        this.debounce('_onUserActivityUpdate', function(){
          this._onUserActivityUpdateAsync(e);
        }, 200);
      },

      _onUserActivityUpdateAsync : function(e) {
        this.userCount = Object.keys(e.users).length;
        this.showUserCount = (this.userCount > 0 ) ? true : false;
      }

    });
  </script>
</dom-module>