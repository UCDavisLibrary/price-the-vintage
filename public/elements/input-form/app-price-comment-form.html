
<dom-module id="app-price-comment-form">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
      }

      #voteCount {
        text-align: center;
        margin:0;
        padding:0;
      }
      h2 {
        margin-top: 0;
        text-transform: capitalize;
      }
      .voting {
        color: #888;
      }
      .voting.voted {
        color: var(--default-primary-color);
      }

      paper-icon-button {
        width: 56px;
        height: 56px;
      }

      table {
        font-size: 16px;
        width: 100%;
      }
    </style>

    <div class="layout">
      <div class="flex">
        <h2 style="text-align: left">[[currentType]]</h2>
        <div id="table"></div>
      </div>
      <div class="voting" hidden$="[[!showVoting]]">
        <div>
          <paper-icon-button 
            id="upVote" 
            class="voting" 
            icon="expand-less" 
            on-click="_upVote">
          </paper-icon-button>
        </div>
        <h2 id="voteCount" class="voting">[[count]]</h2>
        <div>
          <paper-icon-button 
            id="downVote" 
            class="voting"  
            icon="expand-more" 
            on-click="_downVote">
          </paper-icon-button>
        </div>
      </div>
    </div>

    <!--<paper-input label="comment"></paper-input>-->
    
  </template>
  <script>

(function(){

    var AuthStateEventLoop = {
      req : {
        event : 'get-auth-state',
      },
      resp : {
        event : 'auth-update',
        handler : function(e) {
          this.userState = e;
          this._updateShowVoting();
        }
      }
    };

    var MarkVotingEventLoop = {
      req : {
        event : 'vote-catalog-page-mark',
        payload : function(vote) {
          return {
            markId : this.mark.id,
            pageId : this.mark.pageId,
            vote : vote
          }
        },
        handler : false
      },

      resp : {
        event : 'catalog-page-marks-update',
        handle : function(e) {
          return (this.mark.id === e.id && e.state === 'loaded');
        },
        handler : function(e) {
          this.show(e);
        }
      }
    };

    Polymer({
      is: 'app-price-comment-form',

      properties : {
        mark : {
          type : Object,
          value : function() {
            return {};
          }
        },
        count : {
          type : Number,
          value : 0
        },
        userState : {
          type : Object,
          value : function() {
            return {}
          }
        },
        showVoting : {
          type : Boolean,
          value : false
        }
      },

      labels : {
        wine: {
          color     : 'Wine Color',
          wineType  : 'Wine Type',
          size      : 'Bottle Size',
          name      : 'Name',
          producer  : 'Producer',
          price     : 'Price per Bottle',
          casePrice : 'Price per Case'
        },
        spirit : {
          name      : 'Name',
          producer  : 'Producer',
          price     : 'Price per Bottle',
          casePrice : 'Price per Case'
        }
      },

      behaviors : [EventBusBehavior, EventLoopBehavior],

      eventLoops : {
        authState : AuthStateEventLoop,
        markVoting : MarkVotingEventLoop
      },

      ready : function() {
        this.eventLoop.authState.req();
      },

      _upVote : function() {
        this._vote('up');
      },

      _downVote : function() {
        this._vote('down');
      },

      _vote : function(value) {
        this.eventLoop.markVoting.req(value);
      },

      show : function(mark) {
        this.count = 0;
        this.mark = mark;

        this.ebEmit('ui-mark-comment-start', mark);

        this.currentType = this.mark.data.type;

        var html = '<table class="style-scope app-price-comment-form">';
        for( var key in this.labels[this.currentType] ) {
          if( this.mark.data[key] ) {
            html += '<tr><td style="font-weight:bold">'+this.labels[this.currentType][key]+'</td><td>'+this.mark.data[key]+'</td></tr>';
          }
        }
        this.$.table.innerHTML = html+'</table>';

        var eles = this.querySelectorAll('.voting');
        for( var i = 0; i < eles.length; i++ ) {
          eles[i].classList.remove('voted');
        }

        var votes = this.mark.data.votes;
        var user = this.userState.user || {};
        this.userVote = '';

        if( votes ) {
          for( var key in votes ) {
            // TODO: remove
            if( typeof votes[key] === 'string' ) continue;

            // TODO: load user factor, so we know what to score.

            if( user.uid === key ) {
              this.userVote = votes[key].type;
            }
            if( votes[key].type === 'up' ) this.count += votes[key].factor || 1;
            else if( votes[key].type === 'down' ) this.count -= votes[key].factor || 1;
          }
        }

        if( this.userVote ) {
          this.$.voteCount.classList.add('voted');
          if( this.userVote === 'up' ) {
            this.$.upVote.classList.add('voted');
          } else if( this.userVote === 'down' ) {
            this.$.downVote.classList.add('voted');
          }
        }

        this._updateShowVoting();
      },

      _updateShowVoting : function() {
        if( this.userState.user && 
            this.userState.user.uid && 
            !this.userState.user.isAnonymous &&
            (this.mark && this.mark.data && !this.mark.data.approved ) ) {
          this.showVoting = true;
        } else {
          this.showVoting = false;
        }
      }
    });

})();
  </script>
</dom-module>
