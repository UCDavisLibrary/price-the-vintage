<link rel="import" href="app-price-comment-form.html">
<link rel="import" href="app-price-edit-form.html">
<link rel="import" href="app-price-edit-wine.html">
<link rel="import" href="app-price-edit-spirit.html">

<dom-module id="app-price-form">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: none;
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(255, 255, 255, .90);
        z-index: 1000;
        border-top: 1px solid white;
        box-shadow: 0 0 10px rgba(0,0,0,.4);
      }

      @media(min-width: 640px) {
        :host {
          left: 10%;
          right: 10%;
        }
      }

      #body {
        overflow: auto;
      }

      #body > div {
        padding: 15px;
      }
    </style>

    <div id="body">
      <div>
        <iron-pages selected="[[type]]" attr-for-selected="id">
          <app-price-edit-form
            id="edit" 
            add-space="[[addSpace]]"
            user-state="[[userState]]"
            on-complete="_onComplete" 
            on-delete="_cancel"
            on-cancel="_cancel">
          </app-price-edit-form>

          <app-price-comment-form 
            id="comment" 
            user-state="[[userState]]"
            on-complete="_onComplete" 
            on-cancel="_cancel">
          </app-price-comment-form>
        </iron-pages>
      </div>
    </div>

  </template>
  <script>

(function(){

    var AuthStateEventLoop = {
      req : {
        event : 'get-auth-state',
      },

      resp : {
        event : 'auth-update',
        handler : function(e) {
          this.userState = e;
        }
      }
    };

    Polymer({
      is: 'app-price-form',

      properties : {
        type : {
          type : String,
          value : 'edit'
        },
        addSpace : {
          type : Boolean,
          value : false
        },
        userState : {
          type : Object,
          value : function() {
            return {}
          }
        }
      },

      behaviors : [EventBusBehavior, EventLoopBehavior],

      eventLoops : {
        authState : AuthStateEventLoop
      },

      ready : function() {
        window.addEventListener('resize', this._resize.bind(this));
        this.eventLoop.authState.req();
        this._resize();
      },

      _resize : function() {
        var h = Math.floor(window.innerHeight * 0.5);

        this.style.maxHeight = h+'px';
        this.$.body.style.maxHeight =  h+'px';

        var maxFormSize = 72 * 7;
        // TODO;
      },

      _onComplete : function() {
        this.hide();
      },

      _cancel : function() {
        this.hide();
      },

      edit : function(mark) {
        if( this.userState && 
            this.userState.user &&
            (this.userState.user.isAdmin || 
            mark.data.user === this.userState.user.uid) ) {
          
          this.type = 'edit';
          this.$.edit.edit(mark);
        } else {
          this.type = 'comment';
          this.$.comment.show(mark);
        }

        this.style.display = 'block';
      },

      create : function(ll) {
        this.type = 'edit';
        this.$.edit.create(ll);
        this.style.display = 'block';
      },

      hide : function() {
        this.style.display = 'none';
      }
    });

})();
  </script>
</dom-module>
