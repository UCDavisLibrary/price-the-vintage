
<dom-module id="app-price-edit-form">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
      }

      .space { 
        width: 25px;
      }

      paper-button[save] {
        color: white;
        background-color: var(--default-primary-color);
      }
    </style>




    <div class="layout">
      <div class="flex">
        <div class="layout center row-form">
          <div>Spirit</div>
          <div>
            <paper-toggle-button 
              id="typeInput" 
              checked
              disabled$="[[disabled]]"
              on-change="_setType">
            </paper-toggle-button>
          </div>
          <div>Wine</div>
          <div class="space"></div>
          <div class="flex">
            <paper-input 
              label="Page Section" 
              disabled$="[[disabled]]"
              placeholder="Red Burgundies / Scotch Whiskies on Sale"
              id="sectionInput" 
              always-float-label>
            </paper-input>
          </div>
        </div>

        <iron-pages selected="[[type]]" attr-for-selected="id" selected-attribute="active">
          <app-price-edit-spirit 
            id="spirit" 
            disabled$="[[disabled]]"
            add-space="[[addSpace]]">
          </app-price-edit-spirit>

          <app-price-edit-wine 
            id="wine" 
            disabled$="[[disabled]]"
            add-space="[[addSpace]]">
          </app-price-edit-wine>
        </iron-pages>
      </div>
      <div>
        <app-price-form-voting id="voting"></app-price-form-voting>
      </div>
    </div>

    <div class="buttons" hidden$="[[disabled]]">
      <div class="layout center">
        <div hidden$="[[!editMode]]">
          <paper-icon-button icon="delete" on-click="_delete"></paper-icon-button>
          <paper-icon-button icon="done" on-click="_approve" hidden$="[[!userState.user.isAdmin]]"></paper-icon-button>
        </div>
        <div class="flex"></div>
        <paper-button on-click="_cancel">Cancel</paper-button>
        <paper-button save on-click="_save">Save</paper-button>
      </div>
    </div>
    
  </template>
  <script>

(function(){

    var AuthStateEventLoop = {
      req : {
        event : 'get-auth-state',
      },

      resp : {
        event : 'auth-update',
        handler : function(e) {
          this.userState = e;
        }
      }
    };

    Polymer({
      is: 'app-price-edit-form',

      properties : {
        addSpace : {
          type : Boolean,
          value : false
        },
        userState : {
          type : Object,
          value : function() {
            return {}
          }
        },
        pageId: {
          type : String,
          value : ''
        },
        disabled : {
          type : Boolean,
          value : false,
          // have to trigger polymers style shim on update (css vars updated)
          observer : 'updateStyles'
        }
      },

      ebBind : {
        'ui-delete-mark' : '_delete',
        'ui-admin-approve-mark' : '_approve',
      },

      behaviors : [EventBusBehavior, EventLoopBehavior],

      eventLoops : {
        authState : AuthStateEventLoop
      },

      ready : function() {
        this.eventLoop.authState.req();
      },
      
      _setType : function(e) {
        if( this.$.typeInput.checked ) {
          this.type = 'wine';
        } else {
          this.type = 'spirit';
        }
      },

      _reset : function() {
        this.type = 'wine';
        this.$.sectionInput.value = '';
        this.$.spirit.reset();
        this.$.wine.reset();
      },

      _approve : function() {
        var data = this._getData();

        this.ebEmit('admin-approve-mark', {
          pageId : this.editMark.pageId,
          markId : this.editMark.id,
          mark : data,
          handler : function(error, success) {
            if( error ) {
              console.error(error);
              return alert('Failed to approve mark :(');
            }
            this.fire('cancel');
          }.bind(this)
        });
      },

      _delete : function() {
        if( !confirm('Are you sure you want to delete this mark?!') ) return;
        this.fire('delete', this.editMark);
      },

      _getData : function() {
        var data = this.$[this.type].getData();
        data.type = this.type;
        data.section = this.$.sectionInput.value;

        if( this.editMode ) {
          data.xy = this.editMark.data.xy;
          data.created = this.editMark.data.created;
          data.updated = this.editMark.data.updated;
          data.user = this.editMark.data.user;
        } else {
          data.xy = [this.ll.lng, this.ll.lat];
        }

        if( data.casePrice ) {
          data.casePrice = parseFloat(data.casePrice);
        }
        if( data.price ) {
          data.price = parseFloat(data.price);
        }
        if( data.year ) {
          data.year = parseInt(data.year);
        }

        return data;
      },

      _save : function() {
        var data = this._getData();

        if( !this.editMode ) {
          this.fire('add-mark');
          this._onAddMark(data);
        } else {
          this.editMark.data = data;
          this._onEditMark();
        }

        this.fire('cancel');
      },

      _onAddMark : function(data) {
        this.ebEmit('add-catalog-page-mark', {
          pageId : this.pageId,
          mark : data
        });

        window.location.hash = this.catalogId + '/' + this.pageId;
      },

      _onEditMark : function() {
        this.ebEmit('edit-catalog-page-mark', {
          pageId : this.pageId,
          markId : this.editMark.id,
          mark : this.editMark.data
        });

        window.location.hash = this.catalogId + '/' + this.pageId;
      },

      _cancel : function() {
        this.fire('cancel');
      },

      show : function(mark) {
        this._reset();

        this.ebEmit('ui-mark-edit-start', mark);

        this.editMode = true;
        this.editMark = mark;
        
        this.$.sectionInput.value = mark.data.section || (this.disabled ? '-' : '');
        this.type = mark.data.type;

        this.$.typeInput.checked = (this.type === 'wine') ? true : false;

        if( mark.data.type === 'wine' ) this.$.wine.edit(mark.data);
        else this.$.spirit.edit(mark.data);

        debugger;
        this.$.voting.show(mark);
      },

      create : function(ll) {
        this.ll = ll;
        this.editMode = false;
        this._reset();
      }
    });

})();
  </script>
</dom-module>
