
<dom-module id="app-page-item">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
        position: relative;
        cursor: pointer;
      }

      .detail {
        position: absolute;
        top: -5px;
        left: -10px;
        padding: 4px;
        background-color: var(--default-primary-color);
        color: white;
        border-radius: 40px;
      }

      .markDetail {
        position: absolute;
        bottom: -5px;
        left: -10px;
        padding: 4px;
        background-color: white;
        color: var(--default-primary-color);
        border-radius: 40px;
      }

      .details {
        position: absolute;
        bottom: 0px;
        left: 0px;
        right: 0px;
        padding: 4px;
        background-color: rgba(156, 39, 176, .9);
        color: white;
      }


      paper-material {
        transition: transform 200ms linear, box-shadow 200ms linear, border 200ms linear;
        border: 2px solid white;
      }

      paper-material.selected {
        border: 2px solid var(--default-primary-color);
      }

      paper-material:hover {
        box-shadow: 0px -2px 15px var(--default-primary-color);
        transform: translateY(5px);
      }

      iron-icon {
        color: var(--light-primary-color);
      }
    </style>


    <paper-material id="root">
      <iron-image 
        class="grid-item-img"
        style="padding:0"
        sizing="cover"
        src="[[imgUrl]]" 
        alt="Catalog Thumbnail Image">
      </iron-image>

      <!--<div class="detail" hidden$="[[!showUserCount]]">
        <span>
          <iron-icon icon="social:group"></iron-icon> [[userCount]]
        </span>
      </div>

      <div class="markDetail" hidden$="[[!showMarkCount]]">
        <span>
          <iron-icon icon="gps:fixed"></iron-icon> [[markCount]]
        </span>
      </div>-->

      <div class="layout center details" hidden$="[[!showDetails]]">
        <div hidden$="[[!showUserCount]]">
          <iron-icon icon="social:group"></iron-icon> [[userCount]]
        </div>
        <div class="flex"></div>
        <div hidden$="[[!showMarkCount]]">
          <iron-icon icon="device:gps-fixed"></iron-icon> [[markCount]]
        </div>
      </div>

    </paper-material>
    
  </template>
  <script>
    Polymer({
      is: 'app-page-item',

      properties : {
        active : {
          type : Boolean,
          value : false,
          observer : '_onUpdate'
        },
        apiHost : {
          type : String,
          value : ''
        },
        catalogId : {
          type : String,
          value : ''
        },
        page : {
          type : Object,
          value : function() {
            return {};
          },
          observer : '_onUpdate'
        },
        imgUrl : {
          type : String,
          computed : '_createImgUrl(apiHost, page)'
        },

        userCount : {
          type : Number,
          value : 0
        },
        showUserCount : {
          type : Boolean,
          value : false
        },
        
        markCount : {
          type : Number,
          value : 0
        },
        showMarkCount : {
          type : Boolean,
          value : false
        },
        showDetails : {
          type : Boolean,
          value : false,
          computed : '_showDetails(showUserCount, showMarkCount)'
        }
      },

      ebBind : {
        'user-activity-update' : '_onUserActivityUpdate',
        'interested-party-request' : '_onInterestedPartyRequest',
        'selected-catalog-page-update' : '_onSelectedCatalogPageUpdate',
        'page-metadata-update' : '_onMetadataUpdate'
      },

      behaviors : [EventBusBehavior],

      _createImgUrl : function(apiHost, page) {
        return apiHost + '/pages/' + page.id + '/thumbnail';
      },

      _showDetails : function(showUserCount, showMarkCount) {
        return showUserCount || showMarkCount;
      },

      _onUpdate : function() {
        if( !this.page ) return;
        if( !this.page.id ) return;

        this.ebEmit('get-selected-catalog-page', {handler: this._onSelectedCatalogPageUpdate.bind(this)});

        this.debounce('_onUpdateAsync', function() {
          this._onUpdateAsync();
        }.bind(this), 50);
      },

      _onUpdateAsync : function() {
        this.ebEmit('get-user-activity', {
          id : this._getActivityPageId(),
          handler : function(e) {
            this._onUserActivityUpdate(e);
          }.bind(this)
        });

        this.ebEmit(
          'get-page-metadata', 
          {
            id : this.page.id,
            handler: this._onMetadataUpdate.bind(this)
          }
        );
      },

      _onMetadataUpdate : function(e) {
        if( e.state !== 'loaded' || e.id !== this.page.id ) return;

        this.metadata = e.payload || {};
        this.markCount = this.metadata.markCount || 0;

        if( this.markCount > 0 ) this.showMarkCount = true;
        else this.showMarkCount = false;
      },

      _onSelectedCatalogPageUpdate : function(selectedPageId) {
        if( this.active && this.page && this.$.root ) {
          if( this.page.id+'' == selectedPageId ) {
            this.$.root.classList.add('selected');
          } else {
            this.$.root.classList.remove('selected');
          }
        } else {
          this.$.root.classList.remove('selected');
        }
      },

      _onInterestedPartyRequest : function() {
        if( this.active && this.catalogId && this.page && this.page.id  ) {
          this.ebEmit(
            'interested-party-response',
            {
              id : this._getActivityPageId(),
              types : ['activity', 'pages']
            }
          );
          this.ebEmit(
            'interested-party-response',
            {
              id : this.page.id,
              types : ['pages']
            }
          );
        }
      },

      _onUserActivityUpdate : function(e) {
        if( e.id+'' !== this.catalogId + '--' + this.page.id ) return;

        this.debounce('_onUserActivityUpdate', function(){
          this._onUserActivityUpdateAsync(e);
        }, 200);
      },

      _onUserActivityUpdateAsync : function(e) {
        var activeUsers = e.users;

        this.userCount = Object.keys(e.users).length;
        this.showUserCount = (this.userCount > 0 ) ? true : false;
      },

      _getActivityPageId : function() {
        return this.catalogId + '--' + this.page.id;
      }

      

    });
  </script>
</dom-module>
