<link rel="import" href="app-page-item.html">

<dom-module id="app-pages-list" >
  <template>
    <style include="shared-styles"></style>
    <style >
      :host {
        display: block;
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom:0;
      }

      [loading-state="loading"] {
        text-align: center;
        margin-top: 100px;
      }

      .grid-item {
        cursor: pointer;
      }
      .detail {
        padding: 5px;
      }
      paper-fab {
        width: 32px; 
        height: 32px;
        padding: 5px;
      }
    </style>

    <div loading-state="loaded">
      <iron-list id="list" items="[[pages]]" as="page" grid style="height:100%">
        <template>
          <app-page-item 
            class="grid-item"
            active="[[active]]"
            catalog-id$="[[catalogId]]" 
            page="[[page]]" 
            api-host="[[apiHost]]"
            on-click="_select">
          </app-page-item>
        </template>
      </iron-list>
    </div>


    <div loading-state="loading">
      <paper-spinner active></paper-spinner>
    </div>

    <div loading-state="error">
      Error fetching wine catalog pages :(
    </div>

  </template>

  <script>
    Polymer({
      is: 'app-pages-list',

      properties: {
        catalogId: {
          type: String,
          value : ''
        },
        active: {
          type: Boolean,
          value: false,
          observer : '_onActive'
        },
        apiHost : {
          type : String,
          value : ''
        }
      },

      behaviors : [EventBusBehavior, StateToggleBehavior],

      ebBind : {
        'selected-catalog-update' : '_onSelectedCatalogUpdate',
        'catalog-pages-update' : '_onCatalogPagesUpdate'
      },

      ready : function() {
        this.toggleState('loading', 'loading-state');
        this._getApi();
      },

      _onActive : function() {
        if( !this.active ) return;
        this._getCatalogPages();
        this._updateListSize();
      },

      _getApi : function() {
        this.ebEmit('get-api-host', {
          handler : function(host) {
            this.apiHost = host;
          }.bind(this)
        });
      },

      _onSelectedCatalogUpdate : function(id) {
        this.catalogId = id;
        this._getCatalogPages();
      },

      _getCatalogPages : function() {
        if( !this.catalogId || !this.active ) return;

        this.ebEmit('get-catalog-pages', {
          id: this.catalogId, 
          handler: this._onCatalogPagesUpdate.bind(this)
        });
      },

      _onCatalogPagesUpdate : function(e) {
        if( !this.active || e.id !== this.catalogId ) return;

        this.toggleState(e.state, 'loading-state');
        if( e.state !== 'loaded' ) return;

        this.pages = e.payload.data;
        this._updateListSize();
      },

      _updateListSize : function() {
        this.debounce('_updateListSize', function(){
          this.$.list.fire('iron-resize');
        }, 50);
      },

      _select : function(e) {
        window.location.hash = this.catalogId+'/'+e.currentTarget.page.id;
      }

    });
  </script>
</dom-module>
