
<dom-module id="app-page-admin-mark-icon">
  <template>
    <style>
      :host {
        display: block;
        height: 200px;
        width: 400px;
      }

      .overflow {
        height: 200px;
        width: 400px;
        overflow: auto;
      }

      #img {
        position: relative;
        height: 200px;
        width: 800px;
      }

      #mark {
        background: red;
        opacity: .8;
        box-shadow: 0 0 2px black;
        width: 12px;
        height: 12px;
        border-radius: 12px;
        top: 14px;
        left: 14px;
        position: absolute;
      }
    </style>

    <div class="overflow">
      <div id="img">
        <div id="mark"></div>
      </div>
    </div>

  </template>
  <script>

    class CatalogPageMarksUpdate extends Mixin(Polymer.Element)
          .with(EventBusMixin, PagesMixin, MarksMixin, ConfigMixin) {

      static get is() {
        return 'app-page-admin-mark-icon';
      }

      static get properties() {
        return  {
          mark : {
            type : Object,
            observer : '_render',
            value : function() {
              return {};
            }
          }
        }
      }

      _getCatalogPage() {
        return super._getCatalogPage(this.mark.page_id);
      }

      _onCatalogPageUpdate(e) {
        if( e.state !== 'loaded' || e.id !== this.mark.page_id ) return;
        this._renderImage(e);
      }

      _getPendingMark(e) {
        if( !this.mark.mark_id ) return;
        return super._getPendingMark(this.mark.page_id, this.mark.mark_id)
                    .then((e) => this._onMarksUpdate(e));
      }

      _onMarksUpdate(e) {
        if( e.state !== 'loaded' || e.id !== this.mark.mark_id ) return;
        this._markReady(e);
      }

      ready() {
        super.ready();
        this._render();
      }

      _render() {
        if( !this.mark ) return
        if( !this.mark.mark_id ) return;
        this.imgHeight = -1;
        this.marker = null;

        this._getCatalogPage();
        this._getPendingMark();
      }

      _markReady(e) {
        this.marker = e;
        this._setPosition();
      }

      _setPosition() {
        if( this.imgHeight !== -1 && this.marker && this.marker.data ) {
          var x = (-1*this.marker.data.xy[0]+20)+'px ';
          var y = (-1*(this.imgHeight - this.marker.data.xy[1])+20)+'px';
          this.$.img.style.backgroundPosition = x+y;
        }
      }

      _renderImage(e) {
        this.page = e;

        var url = this.apiHost+'/media?select=contents&media_id=eq.'+this.page.payload.media_id;
        var img = new Image();
        img.onload = function() {
          this.imgHeight = img.naturalHeight;
          this._setPosition();
        }.bind(this);
        img.src = url;

        this.$.img.style.backgroundImage = 'url("'+url+'")';
      }

    }

    window.customElements.define(CatalogPageMarksUpdate.is, CatalogPageMarksUpdate);
  </script>
</dom-module>
