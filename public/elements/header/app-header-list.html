
<dom-module id="app-header-list">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
      }

      #searchContainer {
        margin: 0 10%;
        position: absolute;
        background-color: white;
        color: black;
        padding: 10px;
        z-index: 10;
        top: 65px;
        width: 80%;
      }
      
      paper-input {
        --paper-input-container-color: white;
        --paper-input-container-focus-color: white;
        --paper-input-container-input-color: white;
        color: white;
        --paper-input-container : {
          margin: 0;
        }
      }

      paper-dialog {
        color: black;
      }

      #outer-input {
        padding: 0 10px 0 5px;
      }
      #input {
        display: block;
        padding: 5px;
        font-size: 22px;
        width: 100%;
        background: var(--dark-primary-color);
        color: white;
        border: 2px solid white;
        border-radius: 4px;
      }
      #input::-webkit-input-placeholder { /* Chrome/Opera/Safari */
        color: white;
      }
      #input::-moz-placeholder { /* Firefox 19+ */
        color: white;
      }
      #input:-ms-input-placeholder { /* IE 10+ */
        color: white;
      }
      #input:-moz-placeholder { /* Firefox 18- */
        color: white;
      }
    </style>

    <div class="layout center">
      <div hidden$="[[!searchBoxActive]]">
        <iron-icon icon="search"></iron-icon>
      </div>
      <img 
          alt="Application Icon"
          src="/images/wine-icon-48.png" 
          srcset="/images/wine-icon-48.png 1x, /images/wine-icon-64.png 1.5x, /images/wine-icon-96.png 2x"  
          hidden$="[[searchBoxActive]]" 
          style="padding-right: 10px" />
      <div class="flex">
        
        <h2 hidden$="[[searchBoxActive]]">
          Price the Vintage <span style="font-size:12px">Alpha</span>
        </h2>

        <div id="outer-input" hidden$="[[!searchBoxActive]]">
          <input id="input" on-keyup="_search" placeholder="Search Catalogs" />
        </div>

      </div>
      <div hidden$="[[!searchBoxActive]]">
        <paper-icon-button state="list" icon="close" on-click="_toggleSearch"></paper-icon-button>
      </div>
      <div hidden$="[[searchBoxActive]]">
        <paper-icon-button state="list" icon="search" on-click="_toggleSearch"></paper-icon-button>
      </div>
    </div>

  </template>
  <script>

(function() {

    var SearchCatalogsEventLoop = {
      req : {
        event : 'search-catalogs',
        handle : function() {
          this.eventLoop.appState.req({
            state: {
              searching : true,
              searchText : this.$.input.value
            }
          });
        },
        payload : function() {
          return {
            query : {
              q : this.$.input.value,
              exact : this.appState.searchExact
            }
          }
        },
        debounce : 500
      },

      resp : {
        event : 'search-catalogs-update',
        handle : function(e) {
          return e.state === 'loaded'
        },
        handler : function(e) {
          this.eventLoop.appState.req({
            state: {
              searching : false
            }
          });
        }
      }
    };

    var AppStateEventLoop = {
      req : {
        event : 'update-app-state'
      },
      resp : {
        event : 'app-state-update',
        handler : function(e) {
          this.appState = e;
        }
      }
    }

    Polymer({
      is: 'app-header-list',

      properties : {
        searchBoxActive : {
          type : Boolean,
          value : false
        },
        appState : {
          type : Object,
          value : function() {
            return {}
          }
        }
      },

      eventLoops : {
        searchCatalogs : SearchCatalogsEventLoop,
        appState : AppStateEventLoop
      },

      behaviors : [EventBusBehavior, EventLoopBehavior],

      attached : function() {
        // if( !window.localStorage.getItem('first-viewing') ) {
        //   this.$.popup.open();
        //   window.localStorage.setItem('first-viewing', 'true');
        // } 
      },

      _toggleSearch : function(){
        this.searchBoxActive = !this.searchBoxActive;

        if( this.searchBoxActive ) {
          this.$.input.focus();
        }

        this.eventLoop.appState.req({
          state: {
            searchBoxActive : this.searchBoxActive
          }
        });
      },

      _search : function() {
        this.eventLoop.searchCatalogs.req();
      }
    });
})();
  </script>
</dom-module>
