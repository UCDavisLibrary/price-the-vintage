
<dom-module id="app-header-editing">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
      }
    </style>

    <div class="layout center">
      <paper-icon-button icon="close" on-click="_cancelEdit"></paper-icon-button>
      <h2 class="flex">Edit Mark</h2>
      <div>
        <div id="icons">
          <paper-icon-button 
            icon="check" 
            on-click="_approve" 
            hidden$="[[!userState.user.isAdmin]]">
          </paper-icon-button>
          <paper-icon-button icon="save" on-click="_save"></paper-icon-button>
          <paper-icon-button icon="delete" id="delete" on-click="_delete"></paper-icon-button>
        </div>
      </div>
    </div>
    
  </template>
  <script>

(function(){

    var AuthStateEventLoop = {
      req : {
        event : 'get-auth-state',
      },

      resp : {
        event : 'auth-update',
        handler : function(e) {
          this.userState = e;
        }
      }
    };

    Polymer({
      is: 'app-header-editing',

      properties : {
        userState : {
          type : Object,
          value : function() {
            return {};
          }
        }
      },

      behaviors : [EventBusBehavior, EventLoopBehavior],

      eventLoops : {
        authState : AuthStateEventLoop
      },

      ebBind : {
        'ui-mark-comment-start' : '_onComment',
        'ui-mark-edit-start' : '_onEdit',
        'selected-catalog-update' : '_onSelectedCatalogUpdate',
        'selected-catalog-page-update' : '_onSelectedCatalogPageUpdate'
      },

      ready : function() {
        this.eventLoop.authState.req();
      },

      _onSelectedCatalogUpdate : function(id) {
        this.catalogId = id;
      },

      _onSelectedCatalogPageUpdate : function(id) {
        this.pageId = id;
      },

      _onComment : function() {
        this.$.icons.style.display = 'none';
      },

      _onEdit : function(mark) {
        this.$.icons.style.display = 'block';
        this.$.delete.style.display = 'none';
        if( this.userState.user && (mark.data.user === this.userState.user.uid || this.userState.user.isAdmin) ) {
          this.$.delete.style.display = 'inline-block';
        }
      },

      _cancelEdit : function() {
        window.location.hash = this.catalogId + '/' + this.pageId;
      },

      _approve : function() {
        this.ebEmit('ui-admin-approve-mark');
      },

      _delete : function() {
        this.ebEmit('ui-delete-mark');
      },

      _save : function() {
        this.ebEmit('ui-save-mark');
      }
    });

})();
  </script>
</dom-module>
