<link rel="import" href="app-page-carousel-search.html">

<dom-module id="app-page-carousel">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
        overflow: hidden;
        background-color: white;
        height: 160px;
      }

      [loading-state="loaded"] {
        white-space: nowrap;
      }

      #root {
        height: 160px;
      }

      #scrollPanel {
        text-align: center;
        padding: 0 10px;
        overflow-x: auto;
        overflow-y: hidden;
      }

      .nav {
        padding: 3px;
      }

      .nav {
        padding: 3px;
        box-shadow: 0 0 5px #333;
        z-index: 5;
      }

      .nav paper-icon-button {
        color: var(--default-primary-color);
        margin-top: 55px;
      }

      .nav paper-icon-button[disabled] {
        color: var(--disabled-text-color);
        margin-top: 55px;
      }

      paper-fab {
        background-color: white;
        color: var(--default-primary-color);
      }

      paper-fab.disabled {
        background-color: white;
        color: var(--disabled-text-color);
      }

      #nextBtn {
        z-index: 5;
        position: absolute;
        top: 85px;
        right: 5px;
      }

      #previousBtn {
        z-index: 5;
        position: absolute;
        top: 85px;
        left: 5px;
      }

      app-page-item[no-search-match] {
        opacity: .2;
      }

    </style>

    <div loading-state="loaded" id="root">
        <paper-fab 
          icon="arrow-back" 
          id="previousBtn" 
          on-click="_previous">
        </paper-fab>

        <div id="scrollPanel">
          <div>
            <template is="dom-repeat" items="[[pages]]" as="page" style="height:80px">
                <app-page-item 
                  style="display:inline-block"
                  class="grid-item"
                  active$="[[active]]"
                  no-search-match$="[[page.noMatch]]"
                  catalog-id$="[[catalogId]]" 
                  page="[[page]]" 
                  api-host="[[apiHost]]"
                  on-click="_select">
                </app-page-item>
            </template>
          </div>
        </div>

        <paper-fab 
          icon="arrow-forward" 
          id="nextBtn" 
          on-click="_next">
        </paper-fab>
    </div>

    <div loading-state="loading" style="text-align: center; padding: 15px">
      <paper-spinner active></paper-spinner>
    </div>
    
  </template>
  <script>

(function() {

    var SelectedCatalogPageEventLoop = {
      req : {event: 'get-selected-catalog-page'},
      resp : {
        event: 'selected-catalog-page-update',
        handler : function(pageId) {
          this.selected = pageId;

          this._updateScroll();
          this._updateButtons();
        }
      }
    };


    var CatalogPagesEventLoop = {
      req : {
        event : 'get-catalog-pages',
        handle : function() {
          return (this.active && this.catalogId)
        },
        payload : function() {
          return {
            id : this.catalogId
          }
        }
      },
      resp : {
        event: 'catalog-pages-update',
        handle : function(e) {
          if( !this.active || e.id !== this.catalogId ) return false;

          this.toggleState(e.state, 'loading-state');
          return (e.state === 'loaded')
        },
        handler : function(e) {
          this.pages = e.payload;
          this.pageOffset = this.pages[0].page;
          this._updateButtons();
          this._updateScroll();
        }
      }
    };

    Polymer({
      is: 'app-page-carousel',

      properties: {
        catalogId: {
          type: String,
          value : ''
        },
        active: {
          type: Boolean,
          value: false,
          observer : '_onActive'
        },
        apiHost : {
          type : String,
          value : ''
        }
      },

      behaviors : [EventBusBehavior, EventLoopBehavior, StateToggleBehavior],

      eventLoops : {
        selectedCatalogPage : SelectedCatalogPageEventLoop,
        catalogPages : CatalogPagesEventLoop
      },

      ebBind : {
        'selected-catalog-update' : '_onSelectedCatalogUpdate',
        'catalog-update' : '_updateScroll',
        'ui-clear-search-catalog-pages' : '_clearSearch',
        'search-catalog-pages-update' : '_searchUpdate'
      },

      ready : function() {
        this.toggleState('loading', 'loading-state');
        this._getApi();
        this.animateScroll = new AnimateScroll();
      },

      _onActive : function() {
        if( !this.active ) return;

        this.eventLoop.selectedCatalogPage.req();
        this.eventLoop.catalogPages.req();
      },

      _getApi : function() {
        this.ebEmit('get-api-host', {
          handler : function(host) {
            this.apiHost = host;
          }.bind(this)
        });
      },

      _onSelectedCatalogPageUpdate : function(pageId) {
        this.selected = pageId;
        this._updateScroll();
        this._updateButtons();
      },

      _updateScroll : function() {
        if( !this.pages || !this.selected ) return;

        var currentPage;
        for( var i = 0; i < this.pages.length; i++ ) {
          if( this.selected === this.pages[i].page_id ) {
            currentPage = this.pages[i];
            break;
          }
        }

        if( currentPage ) {
          var hw = Math.floor( window.innerWidth / 2);
          var position = 114 * (currentPage.page - this.pageOffset);

          var start = this.$.scrollPanel.scrollLeft;
          var stop;

          if( position > hw ) {
            stop = position - hw + 95;
          } else {
            stop = 0;
          }

          this.animateScroll.run(start, stop, 300, function(scroll){
            this.$.scrollPanel.scrollLeft = scroll;
          }.bind(this));

        }
      },

      _onSelectedCatalogUpdate : function(id) {
        this.catalogId = id;

        this.eventLoop.catalogPages.req();
        this._updateButtons();
      },

      _getPageNumber : function() {
        if( !this.pages ) return -1;

        for( var i = 0; i < this.pages.length; i++ ) {
          if( this.pages[i].page_id === this.selected ) {
            return this.pages[i].page;
          }
        }
      },

      _getPageIdFromPageNumber : function(page) {
        if( !this.pages ) return -1;

        for( var i = 0; i < this.pages.length; i++ ) {
          if( this.pages[i].page === page ) {
            return this.pages[i].page_id;
          }
        }
      },

      _updateButtons : function() {
        var page = this._getPageNumber();
        
        this.$.previousBtn.classList.remove('disabled');
        this.$.nextBtn.classList.remove('disabled');
        
        if( this.pages && page == this.pages[0].page ) {
          this.$.previousBtn.classList.add('disabled');
        }

        if( this.pages && page === this.pages[this.pages.length-1].page ) {
          this.$.nextBtn.classList.add('disabled');
        }
      },

      _previous : function(e) {
        if( e.currentTarget.classList.contains('disabled') ) return;
        var page = this._getPageNumber()-1;
        
        if( this.searchResults ) {
          while( !this._getResultsPageById(this.searchResults, this._getPageIdFromPageNumber(page)) ) {
            page--;
            if( page === -1 ) {
              return;
            }
          }
        }

        this._onNavBtnClick(page);
      },

      _next : function(e) {
        if( e.currentTarget.classList.contains('disabled') ) return;
        var page = this._getPageNumber()+1

        if( this.searchResults ) {
          while( !this._getResultsPageById(this.searchResults, this._getPageIdFromPageNumber(page)) ) {
            page++;
            if( page === this.pages.length ) {
              return;
            }
          }
        }

        this._onNavBtnClick(page);
      },

      _onNavBtnClick : function(page) {
        this.selected = this._getPageIdFromPageNumber(page);
        this._updateScroll();
        this._updateButtons();

        var pages = this.querySelectorAll('app-page-item');
        for( var i = 0; i < pages.length; i++ ) {
          pages[i].onTmpSelectPageUpdate(this.selected);
        }
      },

      _select : function(e) {
        window.location.hash = this.catalogId+'/'+e.currentTarget.page.page_id;
      },

      _clearSearch : function() {
        this.searchResults = null;
        this.pages.forEach(function(page, index){
          this.set('pages.'+index+'.noMatch', false);
        }.bind(this));
      },

      _searchUpdate : function(e) {
        if( e.state !== 'loaded' ) return;

        this.searchResults = e.results.results;

        this.pages.forEach(function(page, index) {
          var matched = this._getResultsPageById(e.results.results, page.page_id);
          this.set('pages.'+index+'.noMatch', !matched ? true : false);
        }.bind(this));

        var page = 0;
        while( !this._getResultsPageById(this.searchResults, this._getPageIdFromPageNumber(page)) ) {
          page++;
          if( page === this.pages.length ) {
            return;
          }
        }
        window.location.hash = this.catalogId + '/' + this._getPageIdFromPageNumber(page);
      },

      _getResultsPageById : function(results, id) {
        for( var i = 0; i < results.length; i++ ) {
          if( results[i].page_id === id ) {
            return results[i];
          }
        }
        return null;
      }

    });

})();
  </script>
</dom-module>