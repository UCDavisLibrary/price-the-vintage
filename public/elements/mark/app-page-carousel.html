<dom-module id="app-page-carousel">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
        overflow: hidden;
        background-color: white;
        height: 160px;
      }

      [loading-state="loaded"] {
        white-space: nowrap;
      }

      #root {
        height: 160px;
      }

      #scrollPanel {
        text-align: center;
        padding: 0 10px;
        overflow-x: auto;
        overflow-y: hidden;
      }

      .nav {
        padding: 3px;
      }

      .nav {
        padding: 3px;
        box-shadow: 0 0 5px #333;
        z-index: 5;
      }

      .nav paper-icon-button {
        color: var(--default-primary-color);
        margin-top: 55px;
      }

      .nav paper-icon-button[disabled] {
        color: var(--disabled-text-color);
        margin-top: 55px;
      }

      paper-fab {
        background-color: white;
        color: var(--default-primary-color);
      }

      paper-fab.disabled {
        background-color: white;
        color: var(--disabled-text-color);
      }

      #nextBtn {
        z-index: 5;
        position: absolute;
        top: 55px;
        right: 5px;
      }

      #previousBtn {
        z-index: 5;
        position: absolute;
        top: 55px;
        left: 5px;
      }

    </style>

    <!--<div loading-state="loaded" id="root">
      <div class="layout">

        <div class="nav">
          <paper-icon-button 
            icon="arrow-back" 
            id="previousBtn" 
            on-click="_previous">
          </paper-icon-button>
        </div>

        <div class="flex" id="scrollPanel">
          <div>
            <template is="dom-repeat" items="[[pages]]" as="page" style="height:80px">
                <app-page-item 
                  style="display:inline-block"
                  class="grid-item"
                  active$="[[active]]"
                  catalog-id$="[[catalogId]]" 
                  page="[[page]]" 
                  api-host="[[apiHost]]"
                  on-click="_select">
                </app-page-item>
            </template>
          </div>
        </div>

        <div class="nav">
          <paper-icon-button 
            icon="arrow-forward" 
            id="nextBtn" 
            on-click="_next">
          </paper-icon-button>
        </div>

      </div>
    </div>-->

    <div loading-state="loaded" id="root">
        <paper-fab 
          icon="arrow-back" 
          id="previousBtn" 
          on-click="_previous">
        </paper-fab>

        <div id="scrollPanel">
          <div>
            <template is="dom-repeat" items="[[pages]]" as="page" style="height:80px">
                <app-page-item 
                  style="display:inline-block"
                  class="grid-item"
                  active$="[[active]]"
                  catalog-id$="[[catalogId]]" 
                  page="[[page]]" 
                  api-host="[[apiHost]]"
                  on-click="_select">
                </app-page-item>
            </template>
          </div>
        </div>

        <paper-fab 
          icon="arrow-forward" 
          id="nextBtn" 
          on-click="_next">
        </paper-fab>
    </div>

    <div loading-state="loading">
      <paper-spinner active></paper-spinner>
    </div>
    
  </template>
  <script>
    Polymer({
      is: 'app-page-carousel',

      properties: {
        catalogId: {
          type: String,
          value : ''
        },
        active: {
          type: Boolean,
          value: false,
          observer : '_onActive'
        },
        apiHost : {
          type : String,
          value : ''
        }
      },

      behaviors : [EventBusBehavior, StateToggleBehavior],

      ebBind : {
        'selected-catalog-update' : '_onSelectedCatalogUpdate',
        'catalog-pages-update' : '_onCatalogPagesUpdate',
        'selected-catalog-page-update' : '_onSelectedCatalogPageUpdate',
        'catalog-update' : '_updateScroll'
      },

      ready : function() {
        this.toggleState('loading', 'loading-state');
        this._getApi();
        this.animateScroll = new AnimateScroll();
      },

      _onActive : function() {
        if( !this.active ) return;
        
        this.ebEmit('get-selected-catalog-page', {handler: this._onSelectedCatalogPageUpdate.bind(this)});
        this._getCatalogPages();
      },

      _getApi : function() {
        this.ebEmit('get-api-host', {
          handler : function(host) {
            this.apiHost = host;
          }.bind(this)
        });
      },

      _onSelectedCatalogPageUpdate : function(pageId) {
        this.selected = pageId;
        this._updateScroll();
        this._updateButtons();
      },

      _updateScroll : function() {
        if( !this.pages || !this.selected ) return;

        var currentPage;
        for( var i = 0; i < this.pages.length; i++ ) {
          if( this.selected === this.pages[i].id+'' ) {
            currentPage = this.pages[i];
            break;
          }
        }

        if( currentPage ) {
          var hw = Math.floor( window.innerWidth / 2);
          var position = 130 * currentPage.page;

          var start = this.$.scrollPanel.scrollLeft;
          var stop;

          if( position > hw ) {
            stop = position - hw + 95;
          } else {
            stop = 0;
          }

          this.animateScroll.run(start, stop, 300, function(scroll){
            this.$.scrollPanel.scrollLeft = scroll;
          }.bind(this));

        }
      },

      _onSelectedCatalogUpdate : function(id) {
        this.catalogId = id;
        this._getCatalogPages();
        this._updateButtons();
      },

      _getCatalogPages : function() {
        if( !this.catalogId || !this.active ) return;

        this.ebEmit('get-catalog-pages', {
          id: this.catalogId, 
          handler: this._onCatalogPagesUpdate.bind(this)
        });
      },

      _onCatalogPagesUpdate : function(e) {
        if( !this.active || e.id+'' !== this.catalogId+'' ) return;

        this.toggleState(e.state, 'loading-state');
        if( e.state !== 'loaded' ) return;

        this.pages = e.payload.data;
        this._updateButtons();
        this._updateScroll();
      },

      _pagesUpdate : function(e) {
        if( e.state !== 'loaded' || e.id+'' !== this.catalog+'' ) return;

        this.pages = e.payload.data;
        this._updateButtons();
      },

      _getPageNumber : function() {
        if( !this.pages ) return -1;

        for( var i = 0; i < this.pages.length; i++ ) {
          if( this.pages[i].id+'' === this.selected ) {
            return this.pages[i].page;
          }
        }
      },

      _getPageIdFromPageNumber : function(page) {
        if( !this.pages ) return -1;

        for( var i = 0; i < this.pages.length; i++ ) {
          if( this.pages[i].page === page ) {
            return this.pages[i].id;
          }
        }
      },

      _updateButtons : function() {
        var page = this._getPageNumber();
        
        this.$.previousBtn.classList.remove('disabled');
        this.$.nextBtn.classList.remove('disabled');
        
        if( page === 0 ) {
          this.$.previousBtn.classList.add('disabled');
        }

        if( this.pages && page === this.pages.length-1 ) {
          this.$.nextBtn.classList.add('disabled');
        }
      },

      _previous : function(e) {
        if( e.currentTarget.classList.contains('disabled') ) return;
        var page = this._getPageNumber()-1;
        page = this._getPageIdFromPageNumber(page);
        window.location.hash = this.catalogId+'/'+page;
      },

      _next : function(e) {
        if( e.currentTarget.classList.contains('disabled') ) return;
        var page = this._getPageNumber()+1;
        page = this._getPageIdFromPageNumber(page);
        window.location.hash = this.catalogId+'/'+page;
      },

      _select : function(e) {
        window.location.hash = this.catalogId+'/'+e.currentTarget.page.id;
      }

    });
  </script>
</dom-module>