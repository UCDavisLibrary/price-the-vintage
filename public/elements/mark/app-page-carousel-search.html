
<dom-module id="app-page-carousel-search">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
        background: white
      }

      input {
        font-size: 16px;
        background: transparent;
        width: 250px;
        padding: 10px;
        margin: 0;
        border-top: none;
        border-left: none;
        border-right: none;
        border-bottom: 1px solid var(--default-primary-color);
      }
      input:focus {
        outline: none;
      }

      paper-icon-button {
        color: var(--default-primary-color);
      }

      #overflow {
        transition: all 300ms linear;
        width: 0;
        overflow: hidden;
      }

      :host([search-active]) #overflow {
        width: 275px;
      }
    </style>

    <div class="layout center">
      <paper-icon-button icon="search" on-click="toggleActive" hidden$="[[searchActive]]"></paper-icon-button>
      <paper-icon-button icon="close" on-click="toggleActive" hidden$="[[!searchActive]]"></paper-icon-button>
      <div id="overflow">
        <input type="text" id="input" placeholder="Search Catalog Pages"  hidden$="[[!searchActive]]" on-keyup="_search" />
      </div>
      <div style="padding-left: 15px">
        <paper-spinner active hidden$="[[!searching]]"></paper-spinner>
        <div hidden$="[[!showResults]]">[[total]]</div>
      </div>
    </div>


  </template>
  <script>
    Polymer({
      is: 'app-page-carousel-search',

      properties : {
        active : {
          type : Boolean,
          value : false,
          observer : '_onActive'
        },
        catalogId : {
          type : String,
          value : ''
        },
        searching : {
          type : Boolean,
          value : false
        },
        searchActive : {
          type : Boolean,
          value : false,
          reflectToAttribute : true
        },
        showResults : {
          type : Boolean,
          value : false
        },
        total : {
          type : String,
          value : ''
        }
      },

      behaviors : [EventBusBehavior],

      ebBind : {
        'app-state-update' : '_onAppStateUpdate',
        'search-catalog-pages-update' : '_onSearchUpdate'
      },

      _onActive : function() {
        if( !this.active ) return;

        if( this.searchActive ) {
          this._search();
        }
      },

      _onAppStateUpdate : function(e) {
        if( e.searchText ) {
          this.searchActive = true;
          this.$.input.value = e.searchText;
        } else {
          this.searchActive = false;
          this.$.input.value = '';
        }
        this.toggleActive
      },

      toggleActive : function() {
        this.searchActive = !this.searchActive;
        this.showResults = false;

        if( this.searchActive ) {
          this.$.input.value = '';
          setTimeout(function() {
            this.$.input.focus();
          }.bind(this), 500);
        } else {
          this.ebEmit('ui-clear-search-catalog-pages');
        }
      },

      _search : function() {
        this.showResults = false;

        if( !this.$.input.value ) {
          this.searching = false;
          return this.ebEmit('ui-clear-search-catalog-pages');
        }

        this.searching = true;
        this.debounce('_searchAsync', this._searchAsync, 200);
      },

      _searchAsync : function() {
        if( !this.$.input.value ) {
          this.searching = false;
          this.showResults = true;
          return this.ebEmit('ui-clear-search-catalog-pages');
        }

        this.ebEmit('search-catalog-pages', {
          query : {
            catalogId : this.catalogId,
            q : this.$.input.value,
          }
        });
      },

      _onSearchUpdate : function(e) {
        if( e.state !== 'loaded' ) return;

        if( !this.$.input.value ) {
          this.searching = false;
          this.showResults = true;
          return this.ebEmit('ui-clear-search-catalog-pages');
        }

        this.searching = false;
        this.showResults = true;
        this.total = 'Matches: '+e.results.total;
      }

    });
  </script>
</dom-module>
