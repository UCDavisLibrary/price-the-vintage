<script src="DrawToolBehavior.js"></script>
<link rel="import" href="app-page-carousel.html">
<link rel="import" href="app-admin-markup-control.html">
<link rel="import" href="app-help-text-control.html">
<link rel="import" href="app-marker.html">

<dom-module id="app-page-markup">
  <template>
    <style include="shared-styles"></style>
    <style>
        :host {
          display: block;
          position: absolute;
          left: 0;
          right: 0;
          top: 0;
          bottom:0;
        }

        .leaflet-div-icon {
          border: none !important;
          background: transparent !important;
        }

        [state="loaded"] {
          position: absolute;
          left: 0;
          right: 0;
          top: 0;
          bottom:0;
        }

        [state="loading"] {
          text-align: center;
          margin-top: 100px;
        }

        #carousel {
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
          z-index: 1000;
        }

        #nothingToDo {
          position: absolute;
          text-align: center;
          left: 0; 
          right: 0;
          top: 0px;
        }
        #nothingToDo paper-material {
          display: inline-block;
          padding: 0 10px;
          max-width: 600px;
          background: white;
          color: var(--default-primary-color);
          text-align: left;
          margin: auto;
          z-index: 500;
        }
    </style>

    <paper-material id="carousel">
      <app-page-carousel-search 
        active="[[active]]"
        catalog-id="[[catalogId]]" 
        id="carousel-search">
      </app-page-carousel-search>
      <app-page-carousel active="[[active]]"></app-page-carousel>
    </paper-material>

    <div id="map" state="loaded"></div>

    <app-price-form 
      id="priceItem" 
      page-id="[[selected]]"
      on-add-mark="_onAddMark" 
      on-cancel="_onAddCancel"
      on-delete="_onDeleteMark">
    </app-price-form>

    <div state="loading">
      <paper-spinner active></paper-spinner>
    </div>

    <div id="nothingToDo">
      <div style="margin: 0 50px">
        <paper-material>
          <div class="layout center">
            <div class="flex">The current page doesn't have any pricing information, so it doesn't need any marking. Donâ€™t despair, plenty more pages do! Click on another!</div>
            <paper-icon-button on-click="_hidePopup" icon="close"></paper-icon-button>
          </div>
        </paper-material>
      </div>
    <div>

  </template>
  <script>

(function() {

    var AuthStateEventLoop = {
      req : {event: 'get-auth-state'},
      resp : {
        event : 'auth-update',
        handler : function(e) {
          this.userState = e;
          this._renderMarkControls();
        }
      }
    };

    var AppStateEventLoop = {
      req : {event: 'get-app-state'},
      resp : {
        event : 'app-state-update',
        handler : function(e) {
          this._renderAppState(e);
        }
      }
    };

    var CatalogPagesEventLoop = {
      req : {
        event : 'get-catalog-pages',
        payload : function() {
          return {id: this.catalogId}
        }
      },
      resp : {
        event : 'catalog-pages-update',
        handle : function(e) {
          if( e.id !== this.catalogId ) return false;

          this.toggleState(e.state, 'loading-state');
          return (e.state === 'loaded')
        },
        handler : function(e) {
          this.pages = e.payload;
          this._reset();
        }
      }
    }


    var PageMarksEventLoop = {
      req : {
        event : 'get-catalog-page-marks',
        payload : function() {
          return {id: this.selected};
        },
        handle : function() {
          return (this.selected && this.active)
        },
        handler : function(marks) {
          marks.forEach(this.eventLoop.pageMarks.resp.bind(this));
        }
      },
      resp : {
        event : 'catalog-page-marks-update',
        handle : function(e) {
          if( e.pageId !== this.selected ) return false;
          return true;
        },
        handler : function(e) {
          if( e.state !== 'loaded' || e.deleted ) {
            this._removeMark(e.id);
            return false;
          }

          this.marks[e.id] = e;

          if( this.mapMarkers[e.id] ) {
            if( e.data.isTemp && this._isMyMark(e) ) {
              return; // don't draw my temp marks
            }

            this.mapMarkers[e.id].setLatLng([e.data.xy[1], e.data.xy[0]]);
          } else {
            this.mapMarkers[e.id] = this._drawMark(e);
          }

          if( this.currentState.markId ) {
            if( this.currentState.markId === e.id ) {
              this._selectAndShowPopup(e.id);
            } else if( this.mapMarkers[e.id] ) {
              this.mapMarkers[e.id]._icon.style.display = 'none';
            }
          }
        }
      }
    }

    // this loop is actually backward :)  but that is how we want it
    // the services are actually pulling us.
    var InterestedPartyEventLoop = {
      req : {
        event : 'interested-party-response',
        payload : function() {
          return {
            id : this.selected,
            types : ['markup']
          }
        }
      },

      resp : {
        event : 'interested-party-request',
        handle : function() {
          return (this.active && this.selected);
        },
        handler : function() {
          this.eventLoop.interestedParty.req();
        }
      }
    };

    Polymer({

      is: 'app-page-markup',

      properties: {
        selected : {
          type : String,
          value : ''
        },
        active: {
          type: Boolean,
          value: false,
          observer: '_onActive'
        },
        marks : {
          type : Object,
          value : function() {
            return {};
          }
        },
        mapMarkers : {
          type : Object,
          value : function() {
            return {};
          }
        },
        map: {
          type: Object,
          value: null
        },
        bounds: {
          type: Object,
          value: null
        }
      },

      behaviors : [EventBusBehavior, EventLoopBehavior, StateToggleBehavior, MarkBehavior],

      eventLoops : {
        authState : AuthStateEventLoop,
        appState : AppStateEventLoop,
        catalogPages : CatalogPagesEventLoop,
        pageMarks : PageMarksEventLoop,
        interestedParty : InterestedPartyEventLoop
      },

      ebBind : {
        'ui-show-mark-noop-popup' : '_showPopup',
        'selected-catalog-update' : '_onSelectedCatalogUpdate',
        'selected-catalog-page-update' : '_onSelectedCatalogPageUpdate',
        'approved-catalog-page-marks-update' : '_onApprovedMarksUpdate'
      },

      ready : function() {
        this._getApi();
        
        this.approvedMarks = {};

        this.eventLoop.authState.req();
        this.eventLoop.appState.req();
      },

      _getApi : function() {
        this.ebEmit('get-api-host', {
          handler : function(host) {
            this.apiHost = host;
          }.bind(this)
        });
      },

      _onActive : function() {
        if( !this.active ) {
          if( this.addMarker && this.drawTool ) {
            this._removeTmpMark();
            this.addMarker = null;
            this.drawTool.disable();
            this.drawTool.enable();
          }
          return;
        }

        this._renderAppState();
        this.eventLoop.pageMarks.req();
        this._updateMapSize();
      },

      _updateMapSize : function() {
        if( !this.map ) return;

        this.debounce('_updateMapSize', function(){
          this.map.invalidateSize();
        }, 50);
      },

      _onSelectedCatalogPageUpdate : function(id) {
        if( this.selected ) this._removeTmpMark();
        if( !id ) return;

        this.selected = id;

        this.toggleState('loading');
        this._hidePopup();

        this._reset();
        this.eventLoop.pageMarks.req();
      },

      _onSelectedCatalogUpdate : function(id) {
        this.catalogId = id;
        this.eventLoop.catalogPages.req();
      },

      _removeMark : function(id) {
        if( this.marks[id] ) {
          delete this.marks[id];
        }

        if( this.mapMarkers[id] ) {
          this.mapMarkers[id].removeFromLayer();
          delete this.mapMarkers[id];
        }
      },

      _reset : function() {
        this.selectedPage = null;

        for( var key in this.marks ) {
          if( this.marks[key].pageId !== this.selected ) {
            delete this.marks[key];
            if( this.mapMarkers[key] ) {
              delete this.mapMarkers[key];
            }
          }
        }

        if( !this.selected || !this.pages ) return;

        for( var i = 0; i < this.pages.length; i++ ) {
          if( this.pages[i].page_id === this.selected ) {
            this.selectedPage = this.pages[i];
            break;
          }
        }

        if( !this.selectedPage ) return;

        var img = new Image();
        var url = this.apiHost+'/media?select=contents&media_id=eq.'+this.selectedPage.media_id;

        if( this.currentImg == url ) {
          this.toggleState('loaded');
          return;
        }

        img.onload = function() {
          this.bounds = [
            [0,0],
            [img.naturalHeight, img.naturalWidth]
          ];
          
          this.toggleState('loaded');
          this._redraw();
        }.bind(this);

        this.currentImg = url;
        img.src = url;
      },

      _renderAppState : function(state) {
        if( state ) {
          this.currentState = state;
        } else {
          state = this.currentState;
        }

        this._hidePopup();

        if( !this.active ) return;

        // there is no /edit stub in url, set map mode to default
        if( !state.editingMark && !state.viewingMark ) {
          this._showHideControls(true);
          this.$.priceItem.hide();
          if( this.addMarker && this.marksLayer ) {
            this.marksLayer.removeLayer(this.addMarker);
          }
          this.addMarker = null;
          this._removeTmpMark();
          this._selectMarker();

        // the draw tool has fired a create mark event.  This marker has
        // been set as pendingLayer
      } else if( this.pendingLayer ) {

          this._showHideControls(false);
          this.$.priceItem.create(this.pendingLayer._latlng);
          this.marksLayer.addLayer(this.pendingLayer);
          this.addMarker = this.pendingLayer;
          this._selectMarker(this.addMarker);
          this.pendingLayer = null;

        // user has clicked a mark to edit
        } else if( state.markId ) {

          if( this.marks[state.markId] ) {
            this._selectAndShowPopup(state.markId);
          }

        // there is a /edit stub in url, but no action required (proly refresh),
        // set to normal (non-edit) mode;
        } else {
          window.location.hash = this.catalogId + '/' + this.selected;
        }
      },

      _isMyMark : function(mark) {
        if( this.userState && (this.userState.user.uid === mark.data.user) ) {
          return true;
        }
        return false;
      },

      _onApprovedMarksUpdate : function(e) {
        if( e.state !== 'loaded' || e.pageId !== this.selected ) return;

        e.payload.forEach(function(mark){
          if( this.mapMarkers[mark.markId] && this.marksLayer ) {
            this.mapMarkers[mark.markId].removeFromLayer();
          }

          this.marks[mark.markId] = {
            state : 'loaded',
            pageId : mark.pageId,
            id : mark.markId,
            data : mark
          };

          this.mapMarkers[mark.markId] = this._drawMark(this.marks[mark.markId]);
        }.bind(this));
      },

      _selectAndShowPopup : function(id) {
        this._showHideControls(false);
        
        this.$.priceItem.show(this.marks[id]);
        
        this._selectMarker(this.mapMarkers[id], id);
      },

      _drawMark : function(mark) {
        if( !this.marksLayer ) return null;

        var marker = document.createElement('app-marker');
        marker.mark = mark;
        marker.catalogId = this.catalogId;
        marker.pageId = this.selected;
        marker.addTo(this.marksLayer);

        return marker;
      },

      _selectMarker : function(marker, id) {

        if( this.selectedMarker ) {
          this.selectedMarker.selected = false;
        }

        this.selectedMarker = marker;
        if( marker ) {
          this.selectedMarker.selected = true;
        }

        if( marker ) {
          for( var key in this.mapMarkers ) {
            if( !this.mapMarkers[key] ) continue;

            if( key === id ) {
              this.mapMarkers[key].show();
            } else {
              this.mapMarkers[key].hide();
            }
          }
        } else {
          for( var key in this.mapMarkers ) {
            if( !this.mapMarkers[key] ) continue;

            this.mapMarkers[key].show();
          }
        }
      },

      _renderMarkControls : function() {
        if( !this.drawControl ) return;
        if( !this.drawControl._container ) return;

        if( !this.userState ) {
          this.drawControl._container.style.display = 'none';
          this.helpTextControl._container.style.display = 'none';
          return 
        } else if ( this.userState.state === 'notLoggedIn' ) {
          this.drawControl._container.style.display = 'none';
          this.helpTextControl._container.style.display = 'none';
          return 
        }

        this.drawControl._container.style.display = 'block';
        this.helpTextControl._container.style.display = 'block';
      },

      _onAddCancel : function() {
        this._removeTmpMark();
        window.location.hash = this.catalogId + '/' + this.selected;
      },

      _onDeleteMark : function(e) {
        var mark = e.detail;

        this.ebEmit('delete-catalog-page-mark', {
          pageId : this.selected,
          markId : mark.id
        });

        window.location.hash = this.catalogId + '/' + this.selected;
      },

      _onAddMark : function(e) {
        this._removeTmpMark();
      },

      _removeTmpMark : function() {
        this.ebEmit('remove-temp-catalog-page-mark', {pageId: this.selected});
        this._selectMarker();
      },

      _hidePopup : function() {
        this.$.nothingToDo.style.display = 'none';
      },

      _showPopup : function() {
        this.$.nothingToDo.style.display = 'block';
      }

    });

})();
  </script>
</dom-module>
