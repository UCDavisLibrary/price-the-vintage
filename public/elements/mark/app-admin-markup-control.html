
<dom-module id="app-admin-markup-control">
  <template>
    <style>
      :host {
        display: block;
        padding-top: 15px;
      }
      .btn {
        cursor: pointer;
        display: inline-block;
        background-color: white;
        border: 2px solid rgba(0,0,0,0.2);
        border-radius: 4px;
        width: 30px;
        height: 30px;
        -webkit-background-clip: padding-box;
        background-clip: padding-box;
      }
      .btn iron-icon {
        padding: 4px;
        width: 22px;
        height: 22px;
        color: #333;
      }
    </style>
    
    <div hidden$="[[!show]]">
      <div>
        <a class="btn" on-click="_setDone">
          <iron-icon icon="done-all"></iron-icon>
        </a>
      </div>
      <div style="margin-top: 5px">
        <a class="btn" on-click="_setIgnore">
          <iron-icon icon="block"></iron-icon>
        </a>
      </div>
    </div>

    <paper-dialog modal id="donePopup">
      <div class="layout center">
        <h1>Page Marks Completed</h1>
      </div>

      <p>Have all entries for this page been marked and approved?</p>

      <div class="buttons">
        <paper-button on-click="_hideDone">Cancel</paper-button>
        <paper-button on-click="_hideDone">Completed</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog modal id="ignorePopup">
      <div class="layout center">
        <h1>Ignore Page</h1>
      </div>

      <p>This page contains no entries to be marked.</p>

      <div class="buttons">
        <paper-button on-click="_hideIgnore">Cancel</paper-button>
        <paper-button on-click="_toggleIgnore" id="ignoreBtn">Ignore Page</paper-button>
      </div>
    </paper-dialog>

  </template>
  <script>

(function(){
    L.Control.AdminControl = L.Control.extend({
        onAdd: function(map) {
            var control = L.DomUtil.create('app-admin-markup-control');
            return control;
        },

        onRemove: function(map) {
            // Nothing to do here
        }
    });

    L.control.adminControl = function(opts) {
        return new L.Control.AdminControl(opts);
    }

    var AuthStateEventLoop = {
      req : {event: 'get-auth-state'},
      resp : {
        event : 'auth-update',
        handler : function(e) {
          this.authState = e;

          if( e.state === 'loggedIn' && e.user.isAdmin ) {
            this.show = true;
          } else {
            this.show = false;
          }

        }
      }
    };

    var SelectedCatalogPageEventLoop = {
      req : {
        event: 'get-selected-catalog-page',
      },
      resp : {
        event : 'selected-catalog-page-update',
        handler : function(id) {
          this.pageId = id;
          if( !this.pageId ) return;

          this.ebEmit('get-page', {
            id : this.pageId,
            handler : this._onPageUpdate.bind(this)
          });
        }
      }
    };


    Polymer({
      is: 'app-admin-markup-control',

      properties : {
        show : {
          type : Boolean,
          value : false
        }
      },

      behaviors : [EventBusBehavior, EventLoopBehavior],

      ebBind : {
        'selected-catalog-page-update' : '_onSelectedCatalogPageUpdate',
        'catalog-page-update' : '_onPageUpdate'
      },

      eventLoops : {
        authState : AuthStateEventLoop,
        selectedPage : SelectedCatalogPageEventLoop
      },

      ready : function() {
        this.$.donePopup.parentElement.removeChild(this.$.donePopup);
        document.body.appendChild(this.$.donePopup);
        
        this.$.ignorePopup.parentElement.removeChild(this.$.ignorePopup);
        document.body.appendChild(this.$.ignorePopup);

        this.eventLoop.authState.req();
        this.eventLoop.selectedPage.req();
      },

      _onPageUpdate : function(e) {
        if( e.state !== 'loaded' ) return;
        console.log(e);
        this.page = e;
      },

      _setDone : function() {
        this.$.donePopup.open();
      },

      _hideDone : function() {
        this.$.donePopup.close();
      },

      _setIgnore : function() {
        if( this.page.payload.editable ) {
          this.$.ignoreBtn.innerHTML = 'Ignore Page';
        } else {
          this.$.ignoreBtn.innerHTML = 'Undo Ignore Page';
        }
        this.$.ignorePopup.open();
      },

      _hideIgnore : function() {
        this.$.ignorePopup.close();
      },

      _toggleIgnore : function() {
        this.ebEmit('admin-ignore-page', {
          pageId : this.pageId,
          ignore : this.page.payload.editable,
          handler : this._onToggleIgnoreComplete.bind(this)
        });
      },

      _onToggleIgnoreComplete : function(err, resp) {
        if( err ) return alert('Failed to update page :(');
        this._hideIgnore();
      }
    });
})();
  </script>
</dom-module>
