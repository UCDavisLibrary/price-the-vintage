
<dom-module id="app-admin-markup-control">
  <template>
    <style>
      :host {
        display: block;
        padding-top: 15px;
      }
      .btn {
        cursor: pointer;
        display: inline-block;
        background-color: white;
        border: 2px solid rgba(0,0,0,0.2);
        border-radius: 4px;
        width: 30px;
        height: 30px;
        -webkit-background-clip: padding-box;
        background-clip: padding-box;
      }
      .btn iron-icon {
        padding: 4px;
        width: 22px;
        height: 22px;
        color: #333;
      }
    </style>
    
    <div hidden$="[[!show]]">
      <div>
        <a class="btn" on-click="_toggleDone">
          <iron-icon icon="done-all"></iron-icon>
        </a>
      </div>
      <div style="margin-top: 5px">
        <a class="btn" on-click="_toggleIgnore">
          <iron-icon icon="block"></iron-icon>
        </a>
      </div>
    </div>

  </template>
  <script>

(function(){
    L.Control.AdminControl = L.Control.extend({
        onAdd: function(map) {
            var control = L.DomUtil.create('app-admin-markup-control');
            return control;
        },

        onRemove: function(map) {
            // Nothing to do here
        }
    });

    L.control.adminControl = function(opts) {
        return new L.Control.AdminControl(opts);
    }

    var AuthStateEventLoop = {
      req : {event: 'get-auth-state'},
      resp : {
        event : 'auth-update',
        handler : function(e) {
          this.authState = e;

          if( e.state === 'loggedIn' && e.user.isAdmin ) {
            this.show = true;
          } else {
            this.show = false;
          }

        }
      }
    };

    var SelectedCatalogPageEventLoop = {
      req : {
        event: 'get-selected-catalog-page',
      },
      resp : {
        event : 'selected-catalog-page-update',
        handler : function(id) {
          this.pageId = id;
          if( !this.pageId ) return;

          this.ebEmit('get-page', {
            id : this.pageId,
            handler : this._onPageUpdate.bind(this)
          });
        }
      }
    };


    Polymer({
      is: 'app-admin-markup-control',

      properties : {
        show : {
          type : Boolean,
          value : false
        }
      },

      behaviors : [EventBusBehavior, EventLoopBehavior],

      ebBind : {
        'catalog-page-update' : '_onPageUpdate'
      },

      eventLoops : {
        authState : AuthStateEventLoop,
        selectedPage : SelectedCatalogPageEventLoop
      },

      ready : function() {
        this.eventLoop.authState.req();
        this.eventLoop.selectedPage.req();
      },

      _onPageUpdate : function(e) {
        if( e.state !== 'loaded' ) return;
        this.page = e;
      },

      _toggleDone : function() {
        this.ebEmit('admin-completed-page', {
          pageId : this.pageId,
          completed : !this.page.payload.completed,
          handler : this._onToggleIgnoreComplete.bind(this)
        });
      },

      _onToggleDoneComplete : function(err, resp) {
        if( err ) return alert('Failed to update page :(');
      },

      _toggleIgnore : function() {
        this.ebEmit('admin-ignore-page', {
          pageId : this.pageId,
          ignore : this.page.payload.editable,
          handler : this._onToggleIgnoreComplete.bind(this)
        });
      },

      _onToggleIgnoreComplete : function(err, resp) {
        if( err ) return alert('Failed to update page :(');
      }
    });
})();
  </script>
</dom-module>
