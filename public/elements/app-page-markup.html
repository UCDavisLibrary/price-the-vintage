<dom-module id="app-page-markup">
  <template>
    <style include="shared-styles"></style>
    <style>
        :host {
          display: block;
          position: absolute;
          left: 0;
          right: 0;
          top: 0;
          bottom:0;
        }

        [state="loaded"] {
          position: absolute;
          left: 0;
          right: 0;
          top: 0;
          bottom:0;
        }

        [state="loading"] {
          text-align: center;
          margin-top: 100px;
        }
    </style>

    <div id="map" state="loaded"></div>
    <app-price-form 
        id="priceItem" 
        on-add-mark="_onAddMark" 
        on-edit-mark="_onEditMark"
        on-cancel="_onAddCancel">
      </app-price-form>

    <div state="loading">
      <paper-spinner active></paper-spinner>
    </div>

  </template>
  <script>
    Polymer({

      is: 'app-page-markup',

      properties: {
        selected : {
          type : String,
          value : ''
        },
        active: {
          type: Boolean,
          value: false,
          observer: '_onActive'
        },
        marks : {
          type : Object,
          value : function() {
            return {};
          }
        },
        map: {
          type: Object,
          value: null
        },
        bounds: {
          type: Object,
          value: null
        }
      },

      behaviors : [EventBusBehavior, StateToggleBehavior],

      ebBind : {
        'selected-catalog-update' : '_onSelectedCatalogUpdate',
        'selected-catalog-page-update' : '_onSelectedCatalogPageUpdate',
        'catalog-page-marks-update' : '_onPageMarksUpdate',
        'app-state-update' : '_onAppStateUpdate'
      },

      ready : function() {
        this._getApi();
      },

      _getApi : function() {
        this.ebEmit('get-api-host', {
          handler : function(host) {
            this.apiHost = host;
          }.bind(this)
        });
      },

      _onActive : function() {
        if( !this.active ) return;

        this._getPageMarks();
        this._updateMapSize();
      },

      _updateMapSize : function() {
        if( !this.map ) return;

        this.debounce('_updateMapSize', function(){
          this.map.invalidateSize();
        }, 50);
      },

      _onSelectedCatalogPageUpdate : function(id) {
        this.selected = id;

        this._reset();
        this._getPageMarks();
      },

      _onSelectedCatalogUpdate : function(id) {
        this.catalogId = id;
      },

      _getPageMarks : function() {
        if( !this.selected || !this.active ) return;

        this.ebEmit('get-catalog-page-marks', {
          id: this.selected, 
          handler: this._onPageMarksLoad.bind(this)
        });
      },

      _onPageMarksLoad : function(marks) {
        marks.forEach(this._onPageMarksUpdate.bind(this));
      },

      _onPageMarksUpdate : function(e) {
        if( !this.active || e.pageId !== this.selected ) return;
        if( e.state !== 'loaded' ) return;

        this.marks[e.id] = e;
        this._drawMark(e);
      },

      _reset : function() {
        this.marks = {};
        if( !this.selected ) return;

        var img = new Image();
        img.onload = function() {
          this.bounds = [
            [0,0],
            [img.naturalHeight, img.naturalWidth]
          ];
          
          this.toggleState('loaded');
          this._redraw();
        }.bind(this);

        img.src = this.apiHost+'/pages/'+this.selected+'/image';
      },

      _onAppStateUpdate : function(state) {
        if( !this.active ) return;

        if( !state.editingMark ) {
          this._showHideControls(true);
          this.$.priceItem.hide();
          if( this.addMarker && this.marksLayer ) {
            this.marksLayer.removeLayer(this.addMarker);
          }
        } else {
          this._showHideControls(false);
        }
      },

      _redraw: function() {
        if ( !this.bounds ) return
      
        if( this.map ) this.map.remove();

        this.map = L.map(this.$.map, {
          crs: L.CRS.Simple,
          minZoom: -2
        });

        var map = this.map;

        // Need to get bounds from image.
        var bounds = this.bounds;
        var image = L.imageOverlay(this.apiHost+'/pages/'+this.selected+'/image', bounds).addTo(map);
        map.fitBounds(bounds);

        this.marksLayer = new L.FeatureGroup();
        map.addLayer(this.marksLayer);

        var markup = this.$.priceItem;
        var PriceMarker = L.Icon.Default;

        // this.marks.data.forEach(function(mark) {
        //   // TODO
        // });

        var options = {
          position: 'topright',
          draw: {
            polyline:false,
            polygon: false,
            circle: false, // Turns off this drawing tool
            rectangle: false,
            marker: {
              icon: new PriceMarker()
            }
          },
          edit: {
            featureGroup: this.marksLayer, 
            remove: false
          }
        };

        var drawControl = new L.Control.Draw(options);
        map.addControl(drawControl);


        map.on(L.Draw.Event.CREATED, function (e) {
          var type = e.layerType,
              layer = e.layer;

          if (type === 'marker') {
            layer.bindPopup('latlng: '+layer._latlng);
          }

          markup.show(layer._latlng);

          this.marksLayer.addLayer(layer);
          this.addMarker = layer;

          window.location.hash = this.catalogId + '/' + this.selected + '/edit';
        }.bind(this));

        for( var key in this.marks ) {
          this._drawMark(this.marks[key]);
        }

        this._updateMapSize();
      },

      _onAddCancel : function() {
         window.location.hash = this.catalogId + '/' + this.selected;
      },

      _showHideControls : function(show) {
        var ele = this.$.map.querySelector('.leaflet-control-container');
        if( !ele ) return;
        ele.style.display = show ? 'block' : 'none';
      },

      _drawMark : function(mark) {
        if( !this.marksLayer ) return;

        var marker = L.marker([mark.data.xy[1], mark.data.xy[0]]);
        marker.bindPopup(this.markToHtml(mark.data));
        marker.on('click', function(){
          this.$.priceItem.edit(mark);
        }.bind(this));
        marker.addTo(this.marksLayer);

        return marker;
      },

      markToHtml : function(mark) {
        var html="<div class=\"price_popup\">";
        var items=[
          'brandname',
          'otherdesignation',
          'vintage_date',
          'country',
          'bottlesize',
          'type',
          'color',
          'region',
          'perprice',
          'caseprice'];

        var label={
          country:'Country',
          otherdesignation:"Other Designation",
          brandname:"Brand Name",
          vintage_date:"Vintage",
          region:"Wine Region",
          bottlesize:"Bottle Size",
          perprice:"Bottle Price",
          caseprice:"Case Price"
        };
        items.forEach(function(i) {
          if (mark[i]) {
            html+="<b>"+((label[i])?label[i]:i)+":</b>  "+mark[i]+"<br/>";
          }
        });
        html+="</div>";
        return html;
      },

      _onAddMark : function(e) {
        var data = e.detail;

        this.ebEmit('add-catalog-page-mark', {
          pageId : this.selected,
          mark : data
        });

        window.location.hash = this.catalogId + '/' + this.selected;
      },

      _onEditMark : function(e) {
        var mark = e.detail;

        this.ebEmit('edit-catalog-page-mark', {
          pageId : this.selected,
          markId : mark.id,
          mark : mark.data
        });

        window.location.hash = this.catalogId + '/' + this.selected;
      },

      add_marks_too : function () {
        console.log("Also Add Marks")
      },

    });
  </script>
</dom-module>
