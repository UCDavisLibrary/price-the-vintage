<link rel="import" href="app-page-admin-mark-icon.html">
<link rel="import" href="app-page-admin-mark-details.html">

<dom-module id="app-review-marks">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
      }

      paper-material {
        margin: 15px;
        background: white;
      }

      tr td {
        padding: 10px !important;
      }

      .light {
        color: var(--secondary-text-color);
      }

      paper-icon-button[nav] {
        color: var(--default-primary-color);
      }

      paper-icon-button[nav][disabled] {
        color: var(--secondary-text-color);
      }
    </style>


    <div style="padding: 15px">
        <div  style="max-width: 400px">
          <h3 style="margin:0">Sort By:</h3>
          <select id="sortInput" on-change="_getPendingMarks">
            <option value="updated.desc">Updated Descending</option>
            <option value="updated.asc">Updated Ascending</option>
            <option value="created.desc">Created Descending</option>
            <option value="created.asc">Created Ascending</option>
            <option value="score.desc">Score Descending</option>
            <option value="score.asc">Score Ascending</option>
          </select>
    </div>

    <div class="layout center" style="margin: 0 40px">
      <div >
        <paper-icon-button nav icon="arrow-back" id="prevBtn" on-click="_prev"></paper-icon-button>
      </div>
      <h2 class="flex" style="text-align: center">
        Showing 
        <span class="light">[[start]]</span> to 
        <span class="light">[[stop]]</span> of 
        <span class="light">[[total]]</span>
      </h2>
      <div>
        <paper-icon-button nav icon="arrow-forward" id="nextBtn" on-click="_next"></paper-icon-button>
      </div>
    </div>

    <paper-material style="overflow-x:auto">
      <app-datatable 
        id="datatable" 
        on-inspect="onInspect"
        on-approve="onApprove"
        on-delete="onDelete"
        loading="[[loading]]"
        header="[[header]]" 
        data="[[marks]]">
        <template>
          <tr>
            <td>
              <app-page-admin-mark-icon 
                api-host$="[[apiHost]]"
                mark="[[row]]"
                page-id="[[row.page_id]]">
              </app-page-admin-mark-icon>
              <div class="light">Created on [[row.createdStr]]</div>
              <div class="light">Updated on [[row.updatedStr]]</div>
            </td>
            <td>
              <app-page-admin-mark-details 
                mark="[[row]]">
              </app-page-admin-mark-details>
            </td>
            <td style="vertical-align:top; text-align:center">
              <h1 style="margin:7px">[[row.score]]</h1>
            </td>
            <td style="white-space:nowrap;vertical-align:top">
              <paper-icon-button icon="create" trigger="inspect"></paper-icon-button>
              <paper-icon-button icon="check" trigger="approve"></paper-icon-button>
              <paper-icon-button icon="delete" trigger="delete"></paper-icon-button>
            </td>
          </tr>
        </template>
      </app-datatable>
    </paper-material>

    <div style="padding: 15px">
      <div class="flex" style="text-align: right">
        <paper-button on-click="_cleanTests" raised style="background:white">Clean Test Marks</paper-button>
        <div>Any mark with section==test will be removed</div>
      </div>
    </div>
    
  </template>
  <script>

    class AppReviewMarks extends Mixin(Polymer.Element)
      .with(EventBusMixin, ConfigMixin, MarksMixin, PagesMixin, AdminMixin) {

      static get is() { return 'app-review-marks' }

      static get properties() {
        return {
          marks : {
            type : Array,
            value : []
          },

          loading : {
            type : Boolean,
            value : false
          },

          sort : {
            type : String,
            value : 'score'
          },

          header : {
            type : Array,
            value : function() {
              return ['Page', 'Data', 'Score', 'Actions'];
            }
          },

          pageIndex : {
            type : Number,
            value : 0
          },
          limit : {
            type : Number,
            value : 10
          },
          total : {
            type : Number,
            value : 0
          },
          stop : {
            type : Number,
            value : 0
          },
          start : {
            type : Number,
            value : 0
          }
        }
      }

      _onPendingMarkSearchUpdate(e) {
        this._onMarksLoad(e);
      }

      _onMarksLoad(e) {
        if( e.state === 'loading' ) return;
        this.loading = false;

        if( e.state == 'error' ) {
          this.marks = [];
          console.error(e);
          return alert('Failed to load user marks')
        }

        if( e.state !== 'loaded' ) return;

        this.searchResults = e;

        var arr = e.payload.results;
        arr.forEach(function(mark) {
          mark.createdStr = new Date(mark.created).toLocaleString();
          mark.updatedStr = new Date(mark.updated).toLocaleString();
        });

        this.marks = arr;
        this._updatePaging();
      }


      _onActive() {
        if( !this.active ) return;
        this._getPendingMarks();
      }

      _cleanTests() {
        this._adminClearTestMarks()
            .then(() => alert('Test marks cleared'));
      }

      _getPendingMarks () {
        if( !this.active ) return;
        this.loading = true;

        var params = {
          order : this.$.sortInput.value,
          limit : this.limit,
          offset : this.limit*this.pageIndex
        };

        super._pendingMarkSearch(params)
            .then((e) => this._onMarksLoad(e));
      }


      _updatePaging() {
        this.start = this.searchResults.payload.start+1;
        this.stop = this.searchResults.payload.stop+1;
        this.total = this.searchResults.payload.total;

        this.$.prevBtn.removeAttribute('disabled');
        this.$.nextBtn.removeAttribute('disabled');

        if( this.searchResults.payload.start === 0 ) {
          this.$.prevBtn.setAttribute('disabled', 'disabled');
        }

        if( this.stop >= this.total ) {
          this.$.nextBtn.setAttribute('disabled', 'disabled');
        }
      }

      _prev() {
        this.pageIndex--;
        this._getPendingMarks();
      }

      _next() {
        this.pageIndex++;
        this._getPendingMarks();
      }

      onDelete(e) {
        var mark = e.detail.data;
        var index = e.detail.index;

        if( !confirm('Are you sure you want to delete this mark?') ) return;

        this._removeMark(mark.page_id, mark.mark_id);

        this.splice('marks', index, 1);
      }

      onApprove(e) {
        var markIndex = e.detail.data;
        var index = e.detail.index;

        if( !confirm('Are you sure you want to approve this mark?') ) return;

        this._getMark(markIndex.page_id, markIndex.mark_id)
            .then((mark) => {
              return this._adminApproveMark(markIndex.page_id,  markIndex.mark_id, mark);
            })
            .then(() => {
              this.splice('marks', index, 1);
            })
            .catch((e) => {
              console.error(e);
              alert('Failed to approve mark :(');
            });
      }

      onInspect(e) {
        var mark = e.detail.data;

        this._getPage(mark.page_id)
            .then((e) => {
              window.location = '/#'+e.payload.catalog_id+'/'+mark.page_id+'/edit/'+mark.mark_id;
            });
      }
    }

    window.customElements.define(AppReviewMarks.is, AppReviewMarks);
  </script>
</dom-module>
