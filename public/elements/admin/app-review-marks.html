<link rel="import" href="app-page-icon.html">

<dom-module id="app-review-marks">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
      }

      paper-material {
        margin: 15px;
        background: white;
      }
    </style>

    <div style="padding: 15px">
      <div class="layout bottom">
        <h3 style="padding-right: 15px">Sort By:</h3>
        <div class="flex">
          <select id="sortInput" on-change="_getPendingMarks">
            <option value="updated.desc">Updated Desc</option>
            <option value="updated.asc">Updated Asc</option>
            <option value="created.desc">Created Desc</option>
            <option value="created.asc">Created Asc</option>
            <option value="score.desc">Score Desc</option>
            <option value="score.asc">Score Asc</option>
          </select>
        </div>
      </div>
    </div>

    <paper-material style="overflow-x:auto">
      <app-datatable 
        id="datatable" 
        on-inspect="onInspect"
        on-approve="onApprove"
        loading="[[loading]]"
        header="[[header]]" 
        data="[[marks]]">
        <template>
          <tr>
            <td>
              <app-page-icon 
                api-host$="[[apiHost]]"
                page-id="[[item.page_id]]">
              </app-page-icon>
            </td>
            <td>[[item.createdStr]]</td>
            <td>[[item.updatedStr]]</td>
            <td>[[item.score]]</td>
            <td style="white-space:nowrap">
              <paper-icon-button icon="create" trigger="inspect"></paper-icon-button>
              <paper-icon-button icon="check" trigger="approve"></paper-icon-button>
            </td>
          </tr>
        </template>
      </app-datatable>
    </paper-material>
    
  </template>
  <script>
    Polymer({
      is: 'app-review-marks',

      properties : {
        active : {
          type : Boolean,
          value : false,
          observer : '_onActive'
        },
        marks : {
          type : Array,
          value : []
        },

        loading : {
          type : Boolean,
          value : false
        },

        sort : {
          type : String,
          value : 'score'
        },

        /**
         * The firebase pagging api is horrid.  You have to keep track of this
         * id, to know where to start from.
         **/
        lastMarkId : {
          type : String,
          value : ''
        },

        hostApi : {
          type : String,
          value : ''
        },

        header : {
          type : Array,
          value : function() {
            return ['Page', 'Created', 'Updated', 'Score', ''];
          }
        }
      },

      behaviors : [EventBusBehavior],
      
      ebBind : {
        'pending-mark-search-update' : '_onMarksLoad'
      },

      ready : function() {
        this._getApiHost();
      },

      _onActive : function() {
        if( !this.active ) return;
        this._getPendingMarks();
      },

      _getPendingMarks : function() {
        this.loading = true;

        this.ebEmit('pending-mark-search', {
          params : {
            order : this.$.sortInput.value
          },
          handler : this._onMarksLoad.bind(this)
        });
      },

      _onMarksLoad : function(e) {
        if( e.state === 'loading' ) return;
        this.loading = false;

        if( e.state == 'error' ) {
          this.marks = [];
          console.error(e);
          return alert('Failed to load user marks')
        }

        var arr = e.payload;
        arr.forEach((mark) => {
          mark.createdStr = new Date(mark.created).toLocaleString();
          mark.updatedStr = new Date(mark.updated).toLocaleString();
        });

        this.marks = arr;
      },

      _getApiHost : function() {
        this.ebEmit('get-api-host', {
          handler : function(host) {
            this.apiHost = host;
          }.bind(this)
        });
      },

      onApprove : function(e) {
        alert('Mark approved (not really)');
      },

      onInspect : function(e) {
        var mark = e.detail.data;

        this.ebEmit('get-page', {
          id : mark.page_id,
          handler : function(e) {
            window.location = '/#'+e.payload.catalog_id+'/'+mark.page_id+'/edit/'+mark.mark_id;
          }
        });
      }

      
    });
  </script>
</dom-module>
