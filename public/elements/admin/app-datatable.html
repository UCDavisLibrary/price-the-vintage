<dom-module id="app-datatable">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
        margin-top: 15px;
      }
      :host([loading]) paper-progress {
        display: block
      }
      paper-progress {
        display: none;
        width: 100%;
      }
      #noResults {
        display : none;
        padding: 20px;
        font-size: 15px;
        text-align: center;
      }
      #table {
        width: 100%;
        border-collapse: collapse;
      }
      table tr th {
        text-align: left;
        padding: 5px;
      }
      table tr td {
        padding: 5px;
      }
      table tr:nth-child(even) {
        background: #eee;
      }
    </style>

    <paper-progress indeterminate></paper-progress>

    <div id="noResults">
      No Results
    </div>

    <table id="table">
      <thead id="head"></thead>
      <tbody id="body"></tbody>
    </table>

  </template>
  <script>
    class AppDatatable extends Mixin(Polymer.Element).with(EventBusMixin) {

      static get is() { return 'app-datatable'; } 

      static get properties() {
        return {
          header : {
            type : Array,
            observer : 'render',
            value : function() {
              return [];
            }
          },
          data : {
            type : Array,
            observer : 'render'
          },
          loading : {
            type : Boolean,
            value : false,
            reflectToAttribute : true
          }
        }
      }

      static get observers() {
        return [
          'render(data.*)',
          'render(header.*)'
        ]
      }

      ready() {
        super.ready();
        this.template = null;
        this.timer = -1;
      }

      connectedCallback () {
        super.connectedCallback();
        
        this.template = this.querySelector('template');
        this.root.appendChild(this.template);
        this.TemplateClass = Polymer.Templatize.templatize(this.template, this);
      }

      render() {
        this.debounce('render', function(){
          this._render();
        }, 100);
      }

      _render() {
        this.$.body.innerHTML = '';

        if( !this.data ) return this.renderNoResults();
        if( this.data.length === 0 ) return this.renderNoResults();

        this.$.table.style.display = 'table';
        this.$.noResults.style.display = 'none';

        if( !this.template  ) {
          return;
        }

        // render header
        var row = document.createElement('tr');
        var th;
        for( var i = 0; i < this.header.length; i++ ) {
          th = document.createElement('th');
          th.innerHTML = this.header[i];
          row.appendChild(th);
        }
        this.$.head.innerHTML = '';
        this.$.head.appendChild(row);

        if( !this.data ) return;

        for( var i = 0; i < this.data.length; i++ ) {
          this.renderRow(this.data[i], i);
        }
      }

      renderNoResults() {
        this.$.table.style.display = 'none';
        this.$.noResults.style.display = 'block';
      }

      renderRow(data, index) {
        console.log({item: data});
        var clone = new this.TemplateClass(data);

        var actions = clone.root.querySelectorAll('[trigger]');
        for( var i = 0; i < actions.length; i++ ) {
          actions[i].addEventListener('click', function(e){
            this.triggerActionEvent(e.currentTarget, data, index);
          }.bind(this));
        }

        // HACK for styles
        if( this.parentElement ) {
          var eles = clone.root.querySelectorAll('*');
          for( var i = 0; i < eles.length; i++ ) {
            eles[i].classList.remove(this.parentElement.nodeName.toLowerCase());
            eles[i].classList.add('style-scope');
            eles[i].classList.add('app-datatable');
          }
        }

        this.$.body.appendChild(clone.root);
      }

      triggerActionEvent(ele, data, index) {
        this.fire(ele.getAttribute('trigger'),
          {
            element : ele,
            data : data,
            index : index
          }
        );
      }

    }
    window.customElements.define(AppDatatable.is, AppDatatable)
  </script>
</dom-module>
