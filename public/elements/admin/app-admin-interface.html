
<dom-module id="app-admin-interface">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    

    <iron-pages selected="{{selected}}" selected-attribute="active">
      <app-review-marks page="reviewMarks"></app-review-marks>
    </iron-pages>

  </template>
  <script>

(function(){

    var AuthStateEventLoop = {
      req : {
        event : 'get-auth-state'
      },
      resp : {
        event : 'auth-update',
        handle : function(e) {
          if( e.state === 'pending' ) return false;
          return true;
        },
        handler : function(e) {
          this.auth = e;
          this._onUpdate();
        }
      }
    }

    var AppStateEventLoop = {
      req : {
        event : 'get-app-state'
      },
      resp : {
        event : 'app-state-update',
        handler : function(e) {
          this.appState = e;
          this._onUpdate();
        }
      }
    }

    Polymer({
      is: 'app-admin-interface',

      properties : {
        selected : {
          type : Number,
          value : 0
        }
      },

      behaviors : [EventBusBehavior, EventLoopBehavior],

      eventLoops : {
        authState : AuthStateEventLoop,
        appState : AppStateEventLoop
      },

      ready : function() {
        this.eventLoop.authState.req();
        this.eventLoop.appState.req();
      },

      _onUpdate : function() {
        this.debounce('_onUpdate', this._onUpdateAsync.bind(this), 100);
      },

      _onUpdateAsync : function() {
        if( this.appState.section !== 'admin' ) return;

        if( this.auth.state === 'notLoggedIn' || !this.auth.user ) {
          window.location.hash = '';
          return;
        } else if( !this.auth.user.isAdmin ) {
          window.location.hash = '';
          return;
        }
      }

    });

})();
  </script>
</dom-module>
